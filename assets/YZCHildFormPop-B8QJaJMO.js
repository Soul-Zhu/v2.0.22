import{d as re,W as ie,m as v,c as ce,K as g,X as le,Y as E,Z as ue,N as de,$ as me,s as P,e as V,i as fe,u as m,r as _,g as S,h as B,a as x,n as M,b as H,k as pe,t as ve,y as $,q as ge,J as we,a0 as he,a1 as Ie}from"./main-BnXXyOo5.js";import{u as Se,a as ye,b as Re,_ as Ce,c as Fe}from"./useDefaultRow-Bhv6lFSR.js";import{u as De}from"./formStore-Byb73AL_.js";import{u as _e}from"./useClearnForm-ePekKxJW.js";import{u as Ne}from"./formEvent.hook-CPQy9-nk.js";import{u as ke}from"./heightValidate-C1QXqfrl.js";import{u as be}from"./useProcessFormData-BB1RW82V.js";import{_ as Ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./LoginFactory-C2TRmDIo.js";import"./wecom.prod-DVLinVsr.js";import"./dynamic-import-helper-BheWnx7M.js";import"./useInitFieldState-EKN-2KHT.js";import"./formWatch-KqHO0hI-.js";import"./useFormEnv-VwQXjqJl.js";import"./encodeext-DBC3bVZy.js";const Pe={class:"post-main"},Ve={class:"post-header"},Be={key:0,class:"post-form"},xe={key:1,class:"childform-button"},Me=re({__name:"YZCHildFormPop",props:{appId:{type:String,default:""},formId:{type:String,default:""},formState:{type:String,default:"New"},formViewModel:{type:Object,default:()=>{}},formName:{type:String,default:""},bringMap:{type:Object,default:()=>{}},show:{type:Boolean,default:!1},formKey:{type:[Number,String],default:""}},emits:["onCancle","onSave"],setup(w,{emit:T}){const L=De(),r=ie(),{parseSrcModel:O,parseSrcComponent:U}=Se(),{createControlConfig:Y}=ye(),{clearFormData:Z}=_e(),{deleteExtendEventHandler:K,deleteFormFieldEvent:A}=Fe(),{loadFetchEvent:G}=Ne(),{executeValidate:j}=ke(),{createDefaultRow:N}=Re(),{buildProcessFormData:W}=be(),k=v(0),i=w,y=v({}),R=v(!1),C=v([]),p=v({}),F=T,h=ce({get:()=>(i.show&&(k.value=new Date().getTime(),q(i.formId)),i.show),set:e=>{F("onCancle",e)}});Ie("formData",p);const q=async e=>{if(!e){g("formId异常","danger");return}const t=le(),o=await L.getFormDefined(e),c=O(o.src),a=U(c);let n=E();const l=J(i.formViewModel,i.bringMap,n),{cfgs:s,cfgForm:u,plains:I}=await Y(a.definition,o,l,ue.CHILDFORM),f=r.getCurrentFormId;if(z(o.name,a,f),i.formState!=="New"){const d=l.data;y.value=N(d),p.value=W(d)}else y.value=N(l.data),p.value=u;C.value=s,r.setRuningFormData(f,p.value),r.setRunningDefaultCfg(f,s),I.forEach(d=>{r.addRunningPlainCfg(f,d)}),t==null||t.remove(),R.value=!0},z=async(e,t,o)=>{const c=await G();if(c&&c[e]){const a=c[e],n=a.funcs;if(n){const s=t.funcs;Object.keys(n).forEach(u=>{s[u]=n[u]}),r.setRuningFunctions(o,s)}else r.setRuningFunctions(o,t.funcs);const l=a.validators;if(l){const s=t.validators;Object.keys(l).forEach(u=>{s[u]=l[u]}),r.setRuningValidators(o,s)}else r.setRuningValidators(o,t.validators)}else r.setRuningFunctions(o,t.funcs),r.setRuningValidators(o,t.validators)},J=(e,t,o)=>{const c=X(e.data,o);if(e){const a=e.data;a.rowId=c;for(const n in t){const l=t[n];Array.isArray(l)?(a[n]||(a[n]=[]),a[n].push(...l),a[n].forEach((s,u)=>{s.activeNames=[u+1],s.rowId=Q(s,E()),s.rowPId=ee(s,c)})):a[n]=l}}return e},X=(e,t)=>i.formState==="New"?t:e.ItemId,Q=(e,t)=>e.ItemId?e.ItemId:t,ee=(e,t)=>e.ParentItemId?e.ParentItemId:t,te=e=>{const t=r.getCurrentFormId;r.setRunningDefaultCfg(t,e),C.value=e},b=de("formRef"),oe=async e=>{if(i.formState==="Read"){D(),F("onSave",null);return}const{renderRef:t}=b.value,o=await j({actionName:"",validationGroup:"",isDefaultTransition:!1,submitConfirm:!1});try{if(await t.validate(),o>0){const d=$("Form.validateMsg",{count:o});g(d,"danger");return}const c=Z(p.value),n={header:{appId:i.appId,formId:i.formId,formState:i.formState},formData:c},l=i.formState=="New"?-1:i.formKey,s=ge.saveNewFormService.url.toFetchUrl({params1:i.appId,params2:l,params3:i.formState}),{success:u,data:I,errorMessage:f}=await we(s,n);if(!u){g(f,"danger");return}he({title:"提示",message:`提交成功！
 单据号: `+I.SN}).then(d=>{D(),F("onSave",I)})}catch(c){const a=$("Form.validateMsg",{count:c.length});g(a,"danger")}},D=()=>{const e=r.getCurrentFormId;if(e.indexOf("_")>0){ne(),r.removeFormIdData(e);const t=e.split("_");t.pop();const o=t.join("_");r.setRuningFormId(o)}else g("历史表单配置异常","danger")},ae=()=>{D(),h.value=!1},ne=()=>{A(!0),K(!0)},se=me({formId:"",appId:"",showSaveButton:!1,viewModel:{},title:"",formState:"",formKey:""});return(e,t)=>{const o=_("YZNav"),c=_("van-button"),a=_("van-popup");return S(),P(a,{teleport:"body",show:m(h),"onUpdate:show":t[1]||(t[1]=n=>fe(h)?h.value=n:null),style:{height:"100vh"},position:"bottom"},{default:V(()=>[B("div",Pe,[B("div",Ve,[H(o,{title:`${w.formName}-${w.formState}`,leftText:e.$t("Global.Back"),showBack:"",onOnLeftClick:ae,rightText:""},null,8,["title","leftText"])]),m(R)?(S(),x("div",Be,[(S(),P(Ce,{cfg:m(C),ref_key:"formRef",ref:b,formRow:m(y),key:m(k),"onUpdate:field":te},null,8,["cfg","formRow"]))])):M("",!0),m(R)?(S(),x("div",xe,[H(c,{type:"primary",block:"",onClick:t[0]||(t[0]=n=>oe(m(se).showSaveButton))},{default:V(()=>[pe(ve(e.$t(`Global.${w.formState}`)),1)]),_:1})])):M("",!0)])]),_:1},8,["show"])}}}),Je=Ee(Me,[["__scopeId","data-v-a5274256"]]);export{Je as default};
