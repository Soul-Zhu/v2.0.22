import{d as Me,L as J,M as Ne,W as De,m as b,c as $,o as $e,x as Te,Z as Be,Y as T,a2 as Q,I as X,a3 as Ue,Q as R,J as je,K as Oe,X as ze,a as m,l as ee,v as te,u as c,h as _,b as P,r as C,n as S,F as B,j as U,t as oe,i as Ge,s as j,e as F,G as ae,a4 as Ke,H as O,q as z,g as v,k as Ye,a5 as ne,R as Ze}from"./main-BnXXyOo5.js";import{u as se}from"./encodeext-DBC3bVZy.js";import{u as Ae}from"./useFormEnv-VwQXjqJl.js";import{u as Le}from"./formWatch-KqHO0hI-.js";import{_ as qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useInitFieldState-EKN-2KHT.js";const xe={class:"grid-div"},We={class:"grid-header"},He={class:"grid-tools"},Je=["onClick"],Qe={key:0,class:"page-nav"},Xe={class:"add-btn"},et=Me({__name:"YZGrid",props:J({cfg:{},parentId:{},parentTable:{},childCollapse:{type:Boolean},formRow:{}},{modelValue:{default:[]},modelModifiers:{}}),emits:J(["update:field"],["update:modelValue"]),setup(G,{emit:le}){const{getMapValue:re}=X(),{isEmpty:ce}=se(),i=Ne(G,"modelValue"),w=De(),d=G,r=b(d.cfg),V=b(d.childCollapse),g=$(()=>w.getCurrentFormId),{getFormEnv:ie}=Ae();$e(async()=>{Te(async()=>{Ee(),Re(),we();const e=ie(),t=w.getRuningIsDarft(g.value);e===Be.POST&&!t&&(await ge(),d.cfg.allowAddRecord&&d.cfg.autoAddRow&&i.value.length===0&&M())})});const M=e=>{const t=d.cfg.children,o={rowId:T()};let a=d.parentId;if(i.value&&i.value.length>0&&(a=i.value[i.value.length-1].rowPId),o.rowPId=a,o.activeNames=[i.value.length+1],t.forEach(n=>{if(n.ctype===Q.YZGrid)o[n.bindModel]=[];else{const s=re(n.fullKey),f=Ue(n.bindModelType,s);o[n.bindModel]=f}}),e){const n=e(o);x([n]),i.value.push(n)}else i.value.push(o)},ue=()=>{M()},I=b({}),K=(e,t,o=!1)=>{const a=e.rowId;return I.value[a]||(I.value[a]=[],t.forEach(n=>{const s=Ke.cloneDeep(n);s.rowId=a,s.rowPId=e.rowPId??d.parentId,s.uuid=T(),s.needWatchChange=o,s.ctype===Q.YZGrid&&!e[s.bindModel]&&(e[s.bindModel]=[]),w.addRunningPlainCfg(g.value,s),I.value[a].push(s)})),I.value[a]},de=$(()=>{if(!r.value.enablePaging)return i.value;const e=(y.value-1)*r.value.pageSize,t=e+r.value.pageSize;return ke.value=e,i.value.slice(e,t)}),fe=e=>{const t=[];r.value.pageSize;for(let o=0;o<e.length;o++){const a={...e[o]};a.activeNames=[],t.push(a)}return t},pe=(e,t,o)=>{const a=I.value[t];a&&a.length>0&&(a[o]=e,I.value[t]=a)},ve=(e,t)=>{const o=t.rowId,a=me(o);delete I.value[o],i.value.splice(e,1),a.forEach(s=>{const f=`autoActiveEvent_${s.uuid}_${s.fullKey}`;R.emit(f,"")});const n=setTimeout(()=>{a.forEach(s=>{w.removeRuningPlainsCfg(g.value,s)}),clearTimeout(n)},200)},me=e=>{const o=w.getRuningPlainsCfg(g.value).filter(n=>n.rowId===e),a=[];return o.forEach(n=>{a.push(n),N(n.rowId,a)}),a},N=(e,t)=>{if(e===void 0)return t;const a=w.getRuningPlainsCfg(g.value).filter(n=>n.rowPId===e);a&&a.length>0&&a.forEach(n=>{t.push(n),N(n.rowId,t)})},Y=e=>e.type===O.table&&e.dataSourceId&&e.tableName?z.getTableDatSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName}):e.type===O.esb&&e.dataSourceId?z.getEsbDataSourceNoPage.url.toFetchUrl({params1:e.dataSourceId}):e.type===O.form&&e.dataSourceId&&e.tableName?z.getFormDataSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName}):"",ge=async()=>{const e=d.cfg.ds;if(!e)return;const t=Y(e),o=A(e),a=await L(t,o);q(a)},{encode:Z,encodeBase64:D}=se(),{getFormValue:he}=X();b(!1);const we=()=>{const e=d.cfg.ds;if(!e)return null;Object.keys(e.filter).length>0&&Object.keys(e.filter).forEach(t=>{const o=e.filter[t];if(o.type!=="const"){const n=`onField_Filter_${o.value}_${g.value}`;R.on(n,_e)}})},A=e=>{const t=new FormData,o=[];Object.keys(e.map).forEach(u=>{o.push(u)});const a=D(Z(o));t.append("c",a);let n=e.orderBy;n&&(n=D(e.orderBy)),t.append("o",n);let s={};Object.keys(e.filter).length>0&&Object.keys(e.filter).forEach(u=>{const l=e.filter[u];s[u]={op:e.filter[u].op,value:l.type==="const"?l.value:he(d.cfg,e.filter[u].value)}});const f=D(Z(s));return t.append("f",f),t},L=async(e,t)=>{const{success:o,errorMessage:a,data:n}=await je(e,t);if(!o){Oe(a,"danger");return}return n},q=(e,t=!1)=>{const o=ze();if(e&&e.length>0){const a=ye(e);i.value=a;const n=x(a,t);if(Promise.all(n).then(s=>{s.forEach(f=>{f.forEach(u=>{})}),o&&o.remove()}),d.cfg.enablePaging){const s=fe(a);i.value=s}}o&&o.remove()};function Ie(e,t){const o=new Set(t);return[...new Set(e)].filter(a=>o.has(a))}const ye=e=>{const t=d.cfg.ds;if(!t)return[];const o=t.map,a=[],n=[];Object.keys(o).forEach(u=>{const l=o[u];n.push(l)});const s=d.cfg.children.map(u=>u.fullKey);return Ie(n,s).length<=0?[]:(e.forEach((u,l)=>{const h={rowId:T(),rowPId:d.parentId,activeNames:[l+1]};Object.keys(o).forEach(p=>{const k=o[p];if(k.indexOf(".")>-1){const E=u[p],Fe=k.split(".")[1];h[Fe]=E}}),a.push(h)}),a)},x=(e,t=!1)=>{const o=d.cfg.children;return e.map(n=>Promise.resolve(K(n,o,t)))},be=(e,t)=>{const a=w.getRuningPlainsCfg(g.value).filter(s=>s.rowPId===e),n=[];a.forEach(s=>{n.push(s),N(s.rowId,n)}),n.forEach(s=>{w.removeRuningPlainsCfg(g.value,s)})},_e=async e=>{const t=d.cfg.ds;if(t){const o=Y(t),a=A(t);i.value.length=0;const n=await L(o,a);be(d.cfg.rowId),q(n,!0)}},{WatchSelfExpress:Ce}=Le(),W=le,Ee=()=>{Ce(r.value,d.formRow,e=>{},e=>{r.value.hidden=e,W("update:field",r.value)},e=>{},e=>{})},H=b(""),Re=()=>{const e=d.cfg,t=`setHidden_${e.uuid}_${e.fullKey}`,o=`setClose_${e.uuid}`;R.on(t,n=>{r.value.hidden=n,W("update:field",r.value)}),R.on(o,n=>{H.value=n});const a=`addRow_${g.value}_${e.uuid}`;R.on(a,n=>{Pe(i.value);for(const s in n)s===e.bindModel&&n[s].forEach(f=>{M(u=>(u={...u,...f},u))})})},Pe=e=>{if(i.value.length>0){const t=i.value[0],o=Object.keys(t).filter(s=>s!=="rowId"&&s!=="rowPId"&&s!=="activeNames"),a=o.length,n=[];for(let s=0;s<i.value.length;s++){const f=i.value[s];let u=0;o.forEach(l=>{ce(f[l])&&u++}),u!==a&&n.push(f)}i.value.length=0,i.value.push(...n)}},Ve=$(()=>i.value.length||0),y=b(1),ke=b(1),Se=e=>{y.value=e};return(e,t)=>{const o=C("YZTitleBar"),a=C("van-icon"),n=C("van-collapse-item"),s=C("van-collapse"),f=C("van-pagination"),u=C("van-button");return v(),m("div",{class:ae(c(H))},[ee(_("div",xe,[_("div",We,[P(o,{title:c(r).fieldLabel},null,8,["title"]),_("div",He,[(v(!0),m(B,null,U(c(r).tools,l=>(v(),m("div",{class:"grid-tools-item",key:l.uniqueId},[(v(),j(ne(l.ctype),{cfg:l,formRow:e.formRow,rowId:e.cfg.uuid},null,8,["cfg","formRow","rowId"]))]))),128)),c(r).children.findIndex(l=>l.ctype==="YZGrid")&&c(r).parentTable!=="$$root"?(v(),m("div",{key:0,class:"grid-child-collapsed",onClick:t[0]||(t[0]=l=>V.value=!c(V))},oe(c(V)?"收起":"展开"),1)):S("",!0)])]),ee(_("div",null,[(v(!0),m(B,null,U(c(de),(l,h)=>(v(),m("div",{key:l.rowId},[P(s,{modelValue:l.activeNames,"onUpdate:modelValue":p=>l.activeNames=p,class:"grid-collapse"},{default:F(()=>[P(n,{name:h+1},{title:F(()=>[c(r).allowAddRecord?(v(),m("span",{key:0,class:ae(["delete-btn",`del_btn_${e.cfg.bindModel}`]),onClick:Ze(p=>ve(c(r).enablePaging?(c(y)-1)*c(r).pageSize+h:h,l),["stop"])},[P(a,{name:"delete-o"})],10,Je)):S("",!0),_("div",null,"# "+oe(c(r).enablePaging?(c(y)-1)*c(r).pageSize+h+1:h+1),1)]),default:F(()=>[(v(!0),m(B,null,U(K(l,c(r).children),(p,k)=>(v(),m("div",{class:"form-item",key:p.uniqueId},[(v(),j(ne(p.ctype),{cfg:p,parentId:l.rowId,parentTable:p.table,key:p.uuid,modelValue:l[p.bindModel],"onUpdate:modelValue":E=>l[p.bindModel]=E,formRow:l,"onUpdate:field":E=>pe(E,l.rowId,k),childCollapse:!c(r).childGridCollapsed},null,40,["cfg","parentId","parentTable","modelValue","onUpdate:modelValue","formRow","onUpdate:field","childCollapse"]))]))),128))]),_:2},1032,["name"])]),_:2},1032,["modelValue","onUpdate:modelValue"])]))),128)),c(r).enablePaging?(v(),m("div",Qe,[P(f,{modelValue:c(y),"onUpdate:modelValue":t[1]||(t[1]=l=>Ge(y)?y.value=l:null),"total-items":c(Ve),"show-page-size":3,onChange:Se,"items-per-page":c(r).pageSize,"force-ellipses":""},null,8,["modelValue","total-items","items-per-page"])])):S("",!0),_("div",Xe,[c(r).allowAddRecord?(v(),j(u,{key:0,size:"small",onClick:ue,icon:"plus",id:`add_btn_${e.cfg.bindModel}`},{default:F(()=>t[2]||(t[2]=[Ye("新增")])),_:1},8,["id"])):S("",!0)])],512),[[te,c(V)||c(r).parentTable==="$$root"]])],512),[[te,!c(r).hidden]])],2)}}}),rt=qe(et,[["__scopeId","data-v-f057ecca"]]);export{rt as default};
