import{w as Re,aS as Ee,aT as Be,c as ye,aU as ce,u as o,d as Me,m as d,$ as de,B as Oe,o as je,Q as pe,aI as Le,r as L,a as oe,g as ne,h as X,b as m,n as ve,e as I,i as E,F as ge,j as ze,aQ as xe,av as We,k as G,t as B,p as Ge,q,K as qe,J as ee,aL as Je,y as P,P as w}from"./main-BnXXyOo5.js";import{T as Qe}from"./TaskCard-DN6TrCgP.js";import Ye from"./RejectPopup-PnbIpnVB.js";import{_ as He}from"./_plugin-vue_export-helper-DlAUqK2U.js";function Ze(c){return Ee()?(Be(c),!0):!1}const Ke=typeof window<"u"&&typeof document<"u";typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;const Xe=Object.prototype.toString,es=c=>Xe.call(c)==="[object Object]";function me(c){return Array.isArray(c)?c:[c]}function ss(c,v,t){return Re(c,v,{...t,immediate:!0})}const ts=Ke?window:void 0;function he(c){var v;const t=ce(c);return(v=t==null?void 0:t.$el)!=null?v:t}function fe(...c){const v=[],t=()=>{v.forEach(i=>i()),v.length=0},M=(i,f,p,T)=>(i.addEventListener(f,p,T),()=>i.removeEventListener(f,p,T)),h=ye(()=>{const i=me(ce(c[0])).filter(f=>f!=null);return i.every(f=>typeof f!="string")?i:void 0}),A=ss(()=>{var i,f;return[(f=(i=h.value)==null?void 0:i.map(p=>he(p)))!=null?f:[ts].filter(p=>p!=null),me(ce(h.value?c[1]:c[0])),me(o(h.value?c[2]:c[1])),ce(h.value?c[3]:c[2])]},([i,f,p,T])=>{if(t(),!(i!=null&&i.length)||!(f!=null&&f.length)||!(p!=null&&p.length))return;const N=es(T)?{...T}:T;v.push(...i.flatMap(J=>f.flatMap(g=>p.map(V=>M(J,g,V,N)))))},{flush:"post"}),y=()=>{A(),t()};return Ze(t),y}const as=500,ls=10;function os(c,v,t){var M,h;const A=ye(()=>he(c));let y,i,f,p=!1;function T(){y&&(clearTimeout(y),y=void 0),i=void 0,f=void 0,p=!1}function N(n){var k,D,b;const[R,j,z]=[f,i,p];if(T(),!(t!=null&&t.onMouseUp)||!j||!R||(k=t==null?void 0:t.modifiers)!=null&&k.self&&n.target!==A.value)return;(D=t==null?void 0:t.modifiers)!=null&&D.prevent&&n.preventDefault(),(b=t==null?void 0:t.modifiers)!=null&&b.stop&&n.stopPropagation();const se=n.x-j.x,re=n.y-j.y,Y=Math.sqrt(se*se+re*re);t.onMouseUp(n.timeStamp-R,Y,z)}function J(n){var k,D,b,R;(k=t==null?void 0:t.modifiers)!=null&&k.self&&n.target!==A.value||(T(),(D=t==null?void 0:t.modifiers)!=null&&D.prevent&&n.preventDefault(),(b=t==null?void 0:t.modifiers)!=null&&b.stop&&n.stopPropagation(),i={x:n.x,y:n.y},f=n.timeStamp,y=setTimeout(()=>{p=!0,v(n)},(R=t==null?void 0:t.delay)!=null?R:as))}function g(n){var k,D,b,R;if((k=t==null?void 0:t.modifiers)!=null&&k.self&&n.target!==A.value||!i||(t==null?void 0:t.distanceThreshold)===!1)return;(D=t==null?void 0:t.modifiers)!=null&&D.prevent&&n.preventDefault(),(b=t==null?void 0:t.modifiers)!=null&&b.stop&&n.stopPropagation();const j=n.x-i.x,z=n.y-i.y;Math.sqrt(j*j+z*z)>=((R=t==null?void 0:t.distanceThreshold)!=null?R:ls)&&T()}const V={capture:(M=t==null?void 0:t.modifiers)==null?void 0:M.capture,once:(h=t==null?void 0:t.modifiers)==null?void 0:h.once},O=[fe(A,"pointerdown",J,V),fe(A,"pointermove",g,V),fe(A,["pointerup","pointerleave"],N,V)];return()=>O.forEach(n=>n())}const ns={class:"task-await"},rs={style:{"padding-left":"10px"}},us={key:0,class:"step-name"},is={class:"step-item"},cs={key:0,class:"select-check-btn"},ds={class:"dialog-div"},ms={class:"dialog-div"},fs={class:"dialog-div"},ps=Me({__name:"TaskAwait",setup(c){const v=d(!1),t=d(!1),M=d(!1),h=de({page:1,start:0,limit:10,ProcessName:"",searchType:""}),A=d(0),y=d([]),i=Oe(),f=d(null);os(f,()=>{V.value=!0},{modifiers:{prevent:!0}});const p=async()=>{v.value&&(v.value=!1,y.value.length=0),h.start=(h.page-1)*h.limit;const e={...h,...J.value},{success:s,errorMessage:l,data:r}=await Ge(q.getAwaitTask.url,e);if(!s){qe(l,"danger");return}const{total:u,children:C}=r;i.setTaskCount(u);const $=C;A.value=u,e.page==1&&(y.value=[]),y.value.push(...$),(y.value.length>=u||$.length<=0)&&(M.value=!0),h.page+=1,t.value=!1},T=e=>({ProcessId:e.ProcessId,ProcessName:e.ProcessName,ProcessVersion:e.ProcessVersion,ProcessIcon:e.IconCls,SerialNum:e.SerialNum,CreateAt:e.CreateAt,Description:e.Description,OwnerDisplayName:e.OwnerDisplayName,TaskID:e.TaskID,StepID:e.StepID,AgentDisplayName:e.AgentDisplayName}),N=()=>{v.value=!0,h.page=1,p()},J=d({});je(()=>{p(),pe.on("onTask_await",e=>{J.value=e.value,h.page=1,v.value=!0,M.value=!1,y.value.length=0,p()})}),Le(()=>{pe.off("onTask_await")});const g=d([]),V=d(!1),O=d(!0),Q=d(!0),n=d(!0),k=d(!0),D=d(!0),b=()=>{V.value=!1,g.value=[],O.value=!0,Q.value=!0,n.value=!0,k.value=!0,D.value=!0},R=e=>{const s=new FormData;return Object.keys(e).forEach(l=>{s.append(l,e[l])}),s},j=async(e,s)=>{if(e&&e.length>0){const r={Method:"GetProcessingPermision",perms:"BatchApprove,Reject,Inform,Transfer,Abort",ids:e},{data:u}=await ee(q.getTaskPermission.url,R(r));let C=Object.keys(u.perms);if(C.length==0)O.value=!0,Q.value=!0,n.value=!0,k.value=!0,D.value=!0;else{let $=C.every(U=>{let S=u.perms[U];return S.BatchApprove&&S.BatchApprove!==void 0}),W=C.every(U=>{let S=u.perms[U];return S.Reject&&S.Reject!==void 0}),le=C.every(U=>{let S=u.perms[U];return S.Inform&&S.Inform!==void 0}),ie=C.every(U=>{let S=u.perms[U];return S.Transfer&&S.Transfer!==void 0}),a=C.every(U=>{let S=u.perms[U];return S.Abort&&S.Abort!==void 0});O.value=!$,Q.value=!W,n.value=!le,k.value=!ie,D.value=!a}}else O.value=!0,Q.value=!0,n.value=!0,k.value=!0,D.value=!0;let l=e.includes(s);e.length==0&&l==!1&&(O.value=!0)},z=async(e,s)=>{let l=g.value.findIndex(r=>r==e.StepID);l>=0?g.value.splice(l,1):g.value.push(e.StepID),await j(g.value,e.StepID)},se=e=>V.value?(z(e),!1):!0,re=()=>{Je({title:P("Form.operateConfirm"),message:P("Form.slectConfirm")}).then(async()=>{const e={items:g.value.map(l=>({ID:l,StepID:l}))},s=await ee(q.batchApprove.url,e,{Method:"BatchApprove"});if(s.success){let l=s.data.processedItems.map(r=>`${r.SerialNum}ï¼š${r.Result}`).join(`
`);w({type:"success",message:l}),b(),N()}else w({type:"danger",message:s.errorMessage})}).catch(()=>{})},Y=d(!1),be=()=>{Y.value=!0},we=async e=>{const s={comments:e,items:g.value.map(r=>{var u;return{ID:r,StepID:r,TaskId:(u=y.value.find(C=>C.StepID===r))==null?void 0:u.TaskID}})},l=await ee(q.batchReject.url,s);if(l.success){let r=`${l.data.processedItems.length}${P("Form.ge")}${P("Form.TaskReject")}`;Y.value=!1,w({type:"success",message:r}),b(),N()}else w({type:"danger",message:l.errorMessage})},ke=()=>{Y.value=!1},H=d(!1),ue=d([]),te=d(!1),De=()=>{H.value=!0},F=de({message:"",users:""}),Ce=()=>{te.value=!0},Se=async()=>{if(!F.users){w({message:P("Form.NotifyU"),type:"danger"});return}if(!F.message){w({message:P("Form.NotifyE"),type:"danger"});return}const e=g.value.map(r=>{let u=y.value.find(C=>C.StepID==r);return{ID:u==null?void 0:u.StepID,TaskID:u==null?void 0:u.TaskID}}),s={accounts:ue.value,comments:F.message,items:e},{data:l}=await ee(q.postNotify.url,s);l.success===!1?w({type:"danger",message:l.message??l.errorMessage}):(w({type:"success",message:P("Form.NotifySu")}),H.value=!1,F.message="",F.users="",b(),N())},Ie=e=>{te.value=!1,ue.value=e.map(s=>s.account),F.users=e.map(s=>s.name).join(",")},Te=()=>{H.value=!1,F.message="",F.users=""},ae=d(!1),_=de({message:"",users:""}),Z=d(!1),Fe=()=>{Z.value=!0},_e=()=>{ae.value=!0},Ue=e=>{ae.value=!1,ue.value=e.map(s=>s.account),_.users=e.map(s=>s.name).join(",")},Pe=()=>{Z.value=!1,_.message="",_.users=""},Ve=async()=>{if(!_.users){w({message:P("Form.selectEntrusting"),type:"danger"});return}if(!_.message){w({message:P("Form.entrustingOpion"),type:"danger"});return}const e=g.value.map(r=>({ID:r,StepID:r})),s={accounts:ue.value,comments:_.message,items:e},l=await ee(q.assigneUserBatch.url,s);l.success?(w({type:"success",message:P("Form.entrustSuccess")}),Z.value=!1,_.message="",_.users="",b(),N()):w({type:"danger",message:l.message||l.errorMessage})},K=d(!1),x=d(""),$e=()=>{K.value=!0},Ae=async()=>{if(!x.value)w({message:P("Form.CanResonE")});else{const e=g.value.map(l=>{let r=y.value.find(u=>u.StepID==l);return{ID:r==null?void 0:r.StepID,TaskID:r==null?void 0:r.TaskID}}),s=await ee(q.cancleTask.url,{comments:x.value,items:e});s.success===!1?w({message:s.errorMessage,type:"danger"}):(w({message:P("Form.CanSu"),type:"success"}),K.value=!1,x.value="",b(),N())}},Ne=()=>{K.value=!1,x.value=""};return(e,s)=>{const l=L("van-checkbox"),r=L("van-checkbox-group"),u=L("van-list"),C=L("van-pull-refresh"),$=L("van-button"),W=L("van-field"),le=L("van-dialog"),ie=L("YZUserSelect");return ne(),oe(ge,null,[X("div",ns,[m(C,{modelValue:o(v),"onUpdate:modelValue":s[2]||(s[2]=a=>E(v)?v.value=a:null),onRefresh:N,style:{flex:"1","overflow-y":"auto"}},{default:I(()=>[m(u,{loading:o(t),"onUpdate:loading":s[1]||(s[1]=a=>E(t)?t.value=a:null),finished:o(M),"immediate-check":!1,"finished-text":e.$t("Work.NoMore"),onLoad:p},{default:I(()=>[(ne(!0),oe(ge,null,ze(o(y),a=>(ne(),oe("div",{key:a.ProcessId,ref_for:!0,ref_key:"taskCard",ref:f},[m(Qe,{process:T(a),"task-type":o(xe).PROCESS,"before-click":se},We({default:I(()=>[a.Recipient?(ne(),oe("div",us,[X("div",is,B(a.Recipient.displayName)+"("+B(a.Recipient.account)+") ",1),G(" "+B(a.StepName),1)])):ve("",!0)]),_:2},[o(V)?{name:"checkbox",fn:I(()=>[X("div",rs,[m(r,{modelValue:o(g),"onUpdate:modelValue":s[0]||(s[0]=U=>E(g)?g.value=U:null),onClick:U=>z(a)},{default:I(()=>[m(l,{name:a.StepID},null,8,["name"])]),_:2},1032,["modelValue","onClick"])])]),key:"0"}:void 0]),1032,["process","task-type"])]))),128))]),_:1},8,["loading","finished","finished-text"])]),_:1},8,["modelValue"]),o(V)?(ne(),oe("div",cs,[m($,{size:"small",type:"primary",disabled:o(O),onClick:re},{default:I(()=>[G(B(e.$t("Form.batchApprove")),1)]),_:1},8,["disabled"]),m($,{size:"small",type:"danger",disabled:o(Q),onClick:be},{default:I(()=>[G(B(e.$t("Form.Refuse")),1)]),_:1},8,["disabled"]),m($,{size:"small",type:"primary",disabled:o(n),onClick:De},{default:I(()=>[G(B(e.$t("Form.Notify")),1)]),_:1},8,["disabled"]),m($,{size:"small",type:"primary",disabled:o(k),onClick:Fe},{default:I(()=>[G(B(e.$t("Form.Entrust")),1)]),_:1},8,["disabled"]),m($,{size:"small",type:"primary",disabled:o(D),onClick:$e},{default:I(()=>[G(B(e.$t("Form.Cancel")),1)]),_:1},8,["disabled"]),m($,{size:"small",type:"danger",onClick:b},{default:I(()=>[G(B(e.$t("Global.Cancle")),1)]),_:1})])):ve("",!0)]),m(Ye,{show:o(Y),onOnProcessRejectConfirm:we,onOnProcessRejectCancel:ke},null,8,["show"]),m(le,{show:o(H),"onUpdate:show":s[5]||(s[5]=a=>E(H)?H.value=a:null),title:e.$t("Form.Notify"),onConfirm:Se,"before-close":()=>!1,onCancel:Te,"show-cancel-button":""},{default:I(()=>[X("div",ds,[m(W,{modelValue:o(F).users,"onUpdate:modelValue":s[3]||(s[3]=a=>o(F).users=a),readonly:"",label:e.$t("Form.Users"),placeholder:e.$t("Form.UserE"),onClick:Ce},null,8,["modelValue","label","placeholder"]),m(W,{modelValue:o(F).message,"onUpdate:modelValue":s[4]||(s[4]=a=>o(F).message=a),rows:"1",autosize:"",label:e.$t("Form.NotifyOpinion"),type:"textarea",placeholder:e.$t("Form.NotifyE")},null,8,["modelValue","label","placeholder"])])]),_:1},8,["show","title"]),m(ie,{show:o(te),"onUpdate:show":s[6]||(s[6]=a=>E(te)?te.value=a:null),multiple:!0,onOnSave:Ie},null,8,["show"]),m(le,{show:o(Z),"onUpdate:show":s[9]||(s[9]=a=>E(Z)?Z.value=a:null),title:e.$t("Form.TaskUrg"),onConfirm:Ve,"before-close":()=>!1,onCancel:Pe,"show-cancel-button":""},{default:I(()=>[X("div",ms,[m(W,{modelValue:o(_).users,"onUpdate:modelValue":s[7]||(s[7]=a=>o(_).users=a),readonly:"",label:e.$t("Form.Users"),placeholder:e.$t("Form.UserE"),onClick:_e},null,8,["modelValue","label","placeholder"]),m(W,{modelValue:o(_).message,"onUpdate:modelValue":s[8]||(s[8]=a=>o(_).message=a),rows:"1",autosize:"",label:e.$t("Form.UrgOpinionE"),type:"textarea",placeholder:e.$t("Form.UrgOpinionE")},null,8,["modelValue","label","placeholder"])])]),_:1},8,["show","title"]),m(ie,{show:o(ae),"onUpdate:show":s[10]||(s[10]=a=>E(ae)?ae.value=a:null),multiple:!1,onOnSave:Ue},null,8,["show"]),m(le,{show:o(K),"onUpdate:show":s[12]||(s[12]=a=>E(K)?K.value=a:null),title:e.$t("Form.Cancel"),onConfirm:Ae,"before-close":()=>!1,onCancel:Ne,"show-cancel-button":""},{default:I(()=>[X("div",fs,[m(W,{modelValue:o(x),"onUpdate:modelValue":s[11]||(s[11]=a=>E(x)?x.value=a:null),rows:"1",autosize:"",label:e.$t("Form.CanReson"),type:"textarea",placeholder:e.$t("Form.CanResonE")},null,8,["modelValue","label","placeholder"])])]),_:1},8,["show","title"])],64)}}}),bs=He(ps,[["__scopeId","data-v-1f44a616"]]);export{bs as default};
