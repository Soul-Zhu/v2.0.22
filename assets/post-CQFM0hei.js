const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./RecordPopup-DKCYEjJ4.js","./main-BnXXyOo5.js","./main-CVDmtNd4.css","./useFormEnv-VwQXjqJl.js","./_plugin-vue_export-helper-DlAUqK2U.js","./RecordPopup-TQTAKzRY.css"])))=>i.map(i=>d[i]);
import{A as Oe,m as d,E as Ve,c as Z,D as Ae,W as Fe,N as He,o as Ee,Q as ue,y as K,K as A,q as Q,J as le,a0 as _e,aI as $e,X as Be,Z as me,aL as xe,d as Pe,a as de,g as z,b as F,r as E,u as r,i as Y,e as W,w as Le,h as j,s as Ce,n as ce,aM as qe,f as je,_ as Ze,l as ze,v as We,t as Ye,a1 as Ge}from"./main-BnXXyOo5.js";import{u as Je}from"./formEvent.hook-CPQy9-nk.js";import{u as Ke,_ as Qe}from"./GobalPopup.vue_vue_type_script_setup_true_lang-IvsNKDOg.js";import{c as Xe,u as eo,a as oo,b as no,_ as to}from"./useDefaultRow-Bhv6lFSR.js";import{u as so}from"./heightValidate-C1QXqfrl.js";import{u as ao}from"./useClearnForm-ePekKxJW.js";import{u as ro,F as io}from"./FormTool-uahxYRvh.js";import{u as uo,P as lo}from"./PostDialog-Cs01WTTG.js";import{u as co}from"./useProcessFormData-BB1RW82V.js";import{_ as mo}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./formStore-Byb73AL_.js";import"./encodeext-DBC3bVZy.js";import"./LoginFactory-C2TRmDIo.js";import"./wecom.prod-DVLinVsr.js";import"./dynamic-import-helper-BheWnx7M.js";import"./useInitFieldState-EKN-2KHT.js";import"./formWatch-KqHO0hI-.js";import"./useFormEnv-VwQXjqJl.js";const{deleteEventHandler:H,deleteFormFieldEvent:fo,deleteExtendEventHandler:po}=Xe(),{getPositionDefined:vo,getFormDefined:go,getPositioniDefindName:Ro}=ro(),{createRequiredFlag:wo}=uo(),ho=Ae(),_o=()=>{const $=Oe(),C=d(""),R=d(""),w=d([]),c=d({}),P=d(!1),D=Ve(),O=d(""),U=d(""),N=d(!1),v=d(!1),p=d(!1),i=d(""),S=d(!1),k=d(""),g=d(""),{parseSrcModel:X,parseSrcComponent:B}=eo(),{loadFetchEvent:ee}=Je();let s=null;const{formUtil:oe,initFormData:ne}=Ke(),M=Z(()=>ho.getApp),{createControlConfig:I}=oo(),x=d(),e=Fe(),{clearFormData:G}=ao(),{createDefaultRow:y}=no(),{buildProcessFormData:De}=co(),fe=async()=>{var he;const o=Be(),{id:a}=$.params,{name:u}=$.query,{draftId:l,memberId:m,providerName:b}=$.query;let h={},_=!1;l?(h.memberId=m,_=!0):m&&(h={memberId:m??"",providerName:b??""});let t=null;if(u?t=await Ro(String(u),l,h):t=await vo(String(a),l,h),!t)return;C.value=t.processVersion,R.value=t.processId,p.value=t.permisions.Consign,i.value=t.processName;const n=t.form.formId;g.value=n,e.setRuningCurrentNodeName(n,t.activityName),e.setRuningCurrentNodeId(n,t.activityId),e.setRunningDarft(n,_),e.setRuningActions(n,t.actions),e.setRuningPositionDefined(n,t),e.setRuningFormId(n),e.setRuningMember(n,t.memberId),e.setRuningOuId(n,t.ouid),e.setRuningOwnerAccount(n,t.ownerAccount),e.setRuningProviderName(n,t.providerName),e.setRuningInitaotr(n,t.initiatorAccount),e.setRuningCurrentPosition(n,t.positions),e.setRuningHeader(n,"draftId",t.draftId),e.setRuningHeader(n,"consignEnabled",!1),e.setRuningHeader(n,"consignReturnType","Return"),e.setRuningHeader(n,"consignRoutingType","Parallel"),e.setRuningHeader(n,"consignUsers",[]),e.setRuningHeader(n,"comments",""),e.setRuningHeader(n,"actionName",""),e.setRuningHeader(n,"context",{Routing:{}});const V=await go(n),ae=X(V.src),T=B(ae);wo(T.definition.components,t.actions);const{cfgs:ke,cfgForm:we,plains:Me}=await I(T.definition,V,t.viewModel,l?me.DARFT:me.POST);if(w.value=ke,e.setRunningDefaultCfg(n,w.value),l){const f=t.viewModel.data;x.value=y(f),c.value=De(f)}else x.value=y(we),c.value=we;if(console.log("formData.value",c.value),e.setRuningFormData(n,c.value),e.setRuningFormId(n),Me.forEach(f=>{e.addRunningPlainCfg(n,f)}),sessionStorage.setItem("env","post"),s=await ee(),s&&s[i.value]){const f=s[i.value],re=f.funcs;if(re){const L=T.funcs;Object.keys(re).forEach(q=>{L[q]=re[q]}),e.setRuningFunctions(n,L)}else e.setRuningFunctions(n,T.funcs);const ie=f.validators;if(ie){const L=T.validators;Object.keys(ie).forEach(q=>{L[q]=ie[q]}),e.setRuningValidators(n,L)}else e.setRuningValidators(n,T.validators)}else e.setRuningFunctions(n,T.funcs),e.setRuningValidators(n,T.validators);if(s&&s[i.value]){const f=s[i.value];await((he=f.onBeforeFormRender)==null?void 0:he.call(f,c.value,"POST")),P.value=!0,ne(c.value),setTimeout(()=>{f.onAfterFormRender&&f.onAfterFormRender.call(f,oe,"POST")},1e3)}else P.value=!0;if(s&&s[i.value]){const f=s[i.value];f.onMounted&&f.onMounted.call(f,"POST")}o&&o.remove()},be=()=>{D.go(-1)},pe=o=>{o&&(k.value=o.comment??""),v.value=!1},Se=()=>{N.value=!1},ve=He("formRef"),ge=d(),te=d(),Re=d(""),Ie=async o=>{te.value=o;const a=ge.value;if(a)if(a.submitConfirm&&a.submitConfirm!=="None"){if(a.submitConfirm==="Prompt"){if(!await ye(String(a.promptMessage)))return;await J(o)}a.submitConfirm==="EnterPassword"&&(O.value=`您选择了 "${a.actionName}",执行本处理需要验证用户密码。`,Re.value="提交验证",N.value=!0)}else await J(o);else await J(o)},Ne=async()=>{if(!U.value)return;const{success:o,data:a,errorMessage:u}=await le(Q.submitCheckAuth.url,{p:btoa(U.value)});if(!o){A(u,"danger");return}if(!a.pass){A("密码不正确","danger");return}N.value=!1,v.value=!1,te.value&&await J(te.value)},J=async o=>{const u={...e.getRuningHeader(g.value)},l=e.getRuningProviderName(g.value),m=e.getRuningMember(g.value),b=e.getRuningOuId(g.value);u.ouid=`${l}.${b}`,u.ownerPosition=`${l}.${m}`,u.consignEnabled=o.openConsign,u.comments=o.comment,u.consignRoutingType=o.consignRoutingType,u.consignReturnType=o.consignReturnType,u.context=o.context,o.openConsign&&o.signUsers&&(u.consignUsers=o.signUsers.split(","));const h=Q.postStartProcess.url.toFetchUrl({params1:R.value,params2:C.value}),_=G(c.value),t={formData:_,header:u};if(s&&s[i.value]){const n=s[i.value];n&&n.onBeforeFormSubmit?n.onBeforeFormSubmit.call(s,_,"POST").then(V=>{V&&se(h,t)}):se(h,t)}else se(h,t)},se=(o,a)=>{le(o,a).then(u=>{const{success:l,data:m,errorMessage:b}=u;if(pe(null),!l){A(b,"danger");return}if(l){if(s&&s[i.value]){const t=s[i.value];t&&t.onAfterFormSubmit&&t.onAfterFormSubmit.call(s,c.value,"POST")}const{SN:h,Accounts:_}=m;_e({title:"提交成功",message:`提交已成功!业务流水号: ${h}
您提交的表单已传送给: ${_.map(t=>t.DisplayName).join(",")}
窗口将被关闭。`}).then(()=>{D.push({path:"/layout/home",replace:!0})})}})},ye=async o=>new Promise((a,u)=>{xe({title:"提交确认",message:o}).then(()=>{a(!0)}).catch(l=>{a(!1)})}),Te=()=>{S.value=!0},Ue=o=>{e.setRunningDefaultCfg(g.value,o),w.value=o};return Ee(async()=>{ue.on("onForm_PostSubmit",async o=>{e.setRuningHeader(g.value,"actionName",o.actionName);const{renderRef:a}=ve.value,{executeValidate:u}=so();if(s&&s[i.value]){const m=s[i.value];if(m&&m.onBeforeValidate&&!await m.onBeforeValidate.call(s,c.value,a,"POST"))return}const l=await u(o);try{if(await a.validate(),l>0){const m=K("Form.validateMsg",{count:l});A(m,"danger");return}if(s&&s[i.value]){const m=s[i.value];if(m&&m.onAfterValidate&&!await m.onAfterValidate.call(s,c.value,a,"POST"))return}ge.value=o,v.value=!0}catch(m){const b=K("Form.validateMsg",{count:m.length});A(b,"danger")}}),ue.on("onForm_DraftSubmit",async()=>{const o=e.getCurrentFormId,a=e.getRuningHeader(o);let u="";const l={...a};l.ouid=e.getRuningOuId(o);const m=`${e.getRuningProviderName(o)}.${e.getRuningMember(o)}`;if(l.ownerPosition=m,Number(a.draftId)===-1){l.actionName="SaveAsDraft",l.comments=k.value;const _=e.getRuningPositionDefined(o),t=_.processId,n=_.processVersion;u=Q.postStartDraft.url.toFetchUrl({params1:t,params2:n})}else l.actionName="SaveDraft",l.comments=k.value,u=Q.postDraftUpdate.url.toFetchUrl({params1:a.draftId});const h={formData:G(c.value),header:l};le(u,h).then(_=>{const{success:t,data:n,errorMessage:V}=_;if(!t){A(V,"danger");return}if(t){const{Id:ae}=n;_e({title:"提示",message:`${Number(a.draftId)===-1?K("Form.SaveSuccess"):K("Form.UpdateSuccess")}`}).then(()=>{e.setRuningHeader(o,"draftId",ae)})}})}),ue.on("onMapCfg_Update",o=>{w.value=o}),await fe()}),$e(()=>{const o=e.getCurrentFormId;fo(!0),po(!0),H("onForm_MoreClose",!0),H("onForm_Agreen",!0),H("onForm_ProcessRead",!0),H("onForm_PostSubmit",!0),H("onForm_DraftSubmit",!0),H("onMapCfg_Update",!0),e.removeFormIdData(o)}),{init:fe,formData:c,fields:w,render:P,onLeftClick:be,showTip:O,password:U,showPass:N,showConsin:p,showContent:v,onCanlePost:pe,onConfirmPost:Ie,onConfirm:Ne,onCancel:Se,formRef:ve,processName:i,dialogTitle:Re,moreShow:S,onMoreClick:Te,app:M,formRow:x,onUpdateField:Ue}},Co={class:"position"},Fo=Pe({__name:"Position",setup($){const C=Fe(),R=Z(()=>C.getCurrentFormId),w=Z(()=>C.getRuningCurrentPosition(R.value)),c=d(!1),P=Z(()=>C.getRuningMember(R.value)),D=Z(()=>{if(!w.value)return"";const v=w.value.find(p=>p.memberId===P.value);return v?v.text:""}),O={text:"text",value:"ouid"},U=()=>{c.value=!0},N=({selectedValues:v})=>{if(c.value=!1,v.length===0)return;const p=v[0],i=w.value.find(S=>S.ouid===p);i&&(C.setRuningMember(R.value,i.memberId),C.setRuningOuId(R.value,p),C.setRuningProviderName(R.value,i.providerName))};return(v,p)=>{const i=E("van-field"),S=E("van-picker"),k=E("van-popup");return z(),de("div",Co,[F(i,{modelValue:r(D),"onUpdate:modelValue":p[0]||(p[0]=g=>Y(D)?D.value=g:null),"is-link":"",readonly:"",name:"picker",label:v.$t("Form.StartPosition"),onClick:U},null,8,["modelValue","label"]),F(k,{show:r(c),"onUpdate:show":p[2]||(p[2]=g=>Y(c)?c.value=g:null),position:"bottom"},{default:W(()=>[F(S,{columns:r(w),"columns-field-names":O,onConfirm:N,onCancel:p[1]||(p[1]=g=>c.value=!1)},null,8,["columns"])]),_:1},8,["show"])])}}}),Po={class:"post-main",id:"postMain"},Do={class:"post-header"},bo={class:"post-position"},So={key:0,class:"post-form"},Io={class:"post-button"},No={class:"pass-tip"},yo={class:"showTip"},To=Pe({__name:"post",setup($){const{onLeftClick:C,render:R,fields:w,showTip:c,password:P,showPass:D,showConsin:O,showContent:U,onCanlePost:N,onConfirmPost:v,onConfirm:p,onCancel:i,formData:S,formRef:k,processName:g,dialogTitle:X,moreShow:B,onMoreClick:ee,formRow:s,onUpdateField:oe}=_o();Ge("formData",S),Le(S,(M,I)=>{window.formDataBase=M},{deep:!0});const ne=je(()=>Ze(()=>import("./RecordPopup-DKCYEjJ4.js").then(M=>M.b),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url));return(M,I)=>{const x=E("van-icon"),e=E("YZNav"),G=E("van-field");return z(),de("div",Po,[j("div",Do,[F(e,{title:r(g),leftText:M.$t("Global.Back"),showBack:"",onOnLeftClick:r(C)},{right:W(()=>[F(x,{name:"more-o",size:"22",onClick:r(ee)},null,8,["onClick"])]),_:1},8,["title","leftText","onOnLeftClick"])]),j("div",bo,[F(Fo)]),F(qe,{name:"van-slide-left"},{default:W(()=>[r(R)?(z(),de("div",So,[F(to,{cfg:r(w),ref_key:"formRef",ref:k,formRow:r(s),"onUpdate:field":r(oe)},null,8,["cfg","formRow","onUpdate:field"])])):ce("",!0)]),_:1}),j("div",Io,[r(R)?(z(),Ce(io,{key:0,env:r(me).POST},null,8,["env"])):ce("",!0)]),F(lo,{show:r(U),consign:r(O),"onUpdate:show":r(N),"onUpdate:confirm":r(v)},null,8,["show","consign","onUpdate:show","onUpdate:confirm"]),F(Qe,{title:r(X),show:r(D),"onUpdate:show":I[1]||(I[1]=y=>Y(D)?D.value=y:null),onOnConfirm:r(p),onOnCancel:r(i)},{tip:W(()=>[j("div",No,Ye(r(c)),1)]),field:W(()=>[F(G,{modelValue:r(P),"onUpdate:modelValue":I[0]||(I[0]=y=>Y(P)?P.value=y:null),type:"password",label:"请输入密码",placeholder:"请输入密码",required:""},null,8,["modelValue"]),ze(j("span",yo,"请输入您的密码",512),[[We,!r(P)]])]),_:1},8,["title","show","onOnConfirm","onOnCancel"]),r(R)?(z(),Ce(r(ne),{key:0,"more-show":r(B),"onUpdate:moreShow":I[2]||(I[2]=y=>Y(B)?B.value=y:null)},null,8,["more-show"])):ce("",!0)])}}}),Go=mo(To,[["__scopeId","data-v-9c9c2391"]]);export{Go as default};
