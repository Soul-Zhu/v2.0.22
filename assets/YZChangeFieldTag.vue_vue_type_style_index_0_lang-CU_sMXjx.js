import{as as K,at as M,J as V,q as i,H as y,I as G,d as H,W as J,m as R,a as Y,s as Q,n as W,b as P,r as Z,e as A,i as z,u as q,F as L,g as C,h as b,j as X,A as v,k as j,t as S,p as ee}from"./main-BnXXyOo5.js";import{u as te}from"./encodeext-DBC3bVZy.js";const{encode:k,encodeBase64:g}=te(),{getFormValue:ae}=G(),se=()=>{const d=async(e,a)=>new Promise((s,r)=>{if(console.log(a.ctype,"field.ctype"),a.ctype=="YZDatetime"){let t=I(e,a);s(t)}else if(a.ctype=="YZCombobox"){let t=c(e,a);s(t)}else if(a.ctype=="YZNumber"){let t=w(e);s(t)}else if(a.ctype=="YZRadiogroup"){let t=_(e,a);s(t)}else if(a.ctype=="YZCheckboxgroup"){let t=h(e,a);s(t)}else if(a.ctype=="YZUser"||a.ctype=="YZUsers"){let t=m(e);s(t)}else if(a.ctype=="YZOu"||a.ctype=="YZOus"){let t=x(e);s(t)}else if(a.ctype=="YZSwitch"){let t=T(e);s(t)}else if(a.ctype=="YZValuetodisplay"){let t=U(e,a);s(t)}else s(e)}),I=(e,a)=>{const s=a;if(e){const r=s.formatter;return K[r](e)}return e},D=e=>e.ds?e.ds.type===y.table&&e.ds.tableName&&e.ds.dataSourceId?i.getTableDatSource.url.toFetchUrl({params1:e.ds.dataSourceId,params2:e.ds.tableName}):e.ds.type===y.esb&&e.ds.dataSourceId?i.getEsbDataSourceNoPage.url.toFetchUrl({params1:e.ds.dataSourceId}):e.ds.type===y.form&&e.ds.dataSourceId&&e.ds.tableName?i.getFormDataSource.url.toFetchUrl({params1:e.ds.dataSourceId,params2:e.ds.tableName}):"":"",p=(e,a)=>{const s=[];e.valueField&&s.push(e.valueField),e.displayField&&s.push(e.displayField),e.map&&Object.keys(e.map).length>0&&s.push(...Object.keys(e.map));const r=new FormData;r.append("c",g(k(s)));let t=e.orderBy;t&&(t=g(t)),r.append("o",t);let o={};return Object.keys(e.filter).length>0&&Object.keys(e.filter).forEach(u=>{const l=e.filter[u];o[u]={op:l.op,value:l.type==="const"?l.value:ae(a,e.filter[u].value)}}),r.append("f",g(k(o))),r},c=async(e,a)=>{const s=a;if(s.use===M.options){let r=s.items.find(t=>t.value==e);return(r==null?void 0:r.text)??e}else if(s.ds){let r=s.ds;const t=D(s),o=p(r,s),{data:u}=await V(t,o),l=r.valueField,f=r.displayField;let F=u.find(N=>N[l]==e);return F?F[f]:e}else return e},w=(e,a)=>e,_=(e,a)=>{let r=a.items.find(t=>t.inputValue===e);return(r==null?void 0:r.boxLabel)||e},h=(e,a)=>{let s=a,r=e.split(","),t=[];return r.forEach(o=>{let u=s.items.find(l=>l.inputValue===o);u?t.push(u.boxLabel):t.push(o)}),t.join(",")},m=async(e,a)=>{if(e){const s=e.split(","),{data:r}=await V(i.getUsersSimple.url,{accounts:s});return r&&r.length>0?r.map(t=>t.text).join(","):e}return e},x=async(e,a)=>{if(e){const s=e.split(","),{data:r}=await V(i.getOrgSimple.url,{ouids:s});return r&&r.length>0?r.map(t=>t.text).join(","):e}return e},T=(e,a)=>e=="1"?"是":"否",U=async(e,a)=>{const s=a;if(s.ds){let r=s.ds;const t=n(s.ds),o=[];o.push(s.ds.displayField);const u=g(k(o));let l=s.ds.orderBy;l&&(l=g(s.ds.orderBy));const f=new FormData;f.append("c",u),f.append("o",l);const F={};F[r.valueField]={op:"=",value:e};const N=g(k(F));f.append("f",N);const{success:ie,errorMessage:ce,data:B}=await V(t,f);r.valueField;const O=r.displayField;let E=B&&B.find($=>$[O]===e);return E?E[O]:e}else return e},n=e=>{let a="";if(!e)return a;switch(e.type){case y.table:a=i.getTableDatSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName});break;case y.esb:a=i.getEsbDataSourceNoPage.url.toFetchUrl({params1:e.dataSourceId});break;case y.form:a=i.getFormDataSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName});break}return a};return{TransferValueToText:d}},re=d=>d.params?d.params.taskId??"":"",oe={class:"change-dialog-wrap"},ne={class:"change-dialog-item-bottom"},le={class:""},ue={class:"change-dialog-item-value"},me=H({__name:"YZChangeFieldTag",props:{field:{type:Object,required:!0}},setup(d){const{TransferValueToText:I}=se(),D=v(),p=J(),c=d,w=n=>{const e=p.getCurrentFormId;if(n.isChild){const s=n.fullKey.split(".")[0],t=p.getRuningPlainsCfg(e).find(o=>o.bindModel===s);return t?t.uniqueId:""}else return"$$root"},_=n=>{const e=n.isChild?n.rowId:null;if(n){const a=p.getCurrentFormId;let s=p.getRuningChangeFields(a),r=w(n);if(s.find(o=>o.fieldId==n.uniqueId&&o.tableId==r&&o.rowKey==e))return!0}return!1},h=R([]),m=R(!1),x=n=>{n.stopPropagation(),T()},T=async()=>{let n=re(D);const e=c.field.isChild?c.field.rowId:null,a=i.getChangedfieldsByUid.url.toFetchUrl({params1:n,params2:encodeURIComponent(w(c.field)),params3:e||"root",params4:c.field.uniqueId}),{data:s}=await ee(a),r=s.changes.map(async(t,o)=>(t.orgValue=await I(t.orgValue,c.field),t.newValue=await I(t.newValue,c.field),t));h.value=[];for(const t of r)try{const o=await t;h.value.push(o)}catch(o){console.error("Error processing item:",o)}m.value=!0},U=n=>{};return(n,e)=>{const a=Z("van-icon"),s=Z("van-tag"),r=Z("van-dialog");return C(),Y(L,null,[_(d.field)?(C(),Q(a,{key:0,class:"chang-tag",name:"info-o",onClick:x})):W("",!0),P(r,{teleport:"body",show:q(m),"onUpdate:show":e[0]||(e[0]=t=>z(m)?m.value=t:null),title:n.$t("Form.EditLog"),onConfirm:U},{default:A(()=>[b("div",oe,[(C(!0),Y(L,null,X(q(h),(t,o)=>(C(),Y("div",{class:"change-dialog-item",key:o},[b("div",ne,[P(s,{type:"primary"},{default:A(()=>[j(S(t.userShortName),1)]),_:2},1024),b("div",le,S(t.modifyTime),1)]),b("div",ue,[j(S(t.orgValue||"【空】")+" ",1),e[1]||(e[1]=b("span",{style:{color:"var(--van-primary-color)"}},"=>",-1)),j(" "+S(t.newValue||"【空】"),1)])]))),128))])]),_:1},8,["show","title"])],64)}}});export{me as _};
