import{d as ee,L as q,M as ae,m as V,o as te,Z as oe,x as le,w as se,Q as b,a as ne,l as re,v as ce,u as i,h as ue,b as x,e as de,i as ie,r as H,G as fe,H as M,q as T,I as me,J as pe,K as ve,g as ge}from"./main-BnXXyOo5.js";import{_ as he}from"./YZChangeFieldTag.vue_vue_type_style_index_0_lang-CU_sMXjx.js";import{u as ye}from"./encodeext-DBC3bVZy.js";import{u as be}from"./useFormEnv-VwQXjqJl.js";import{u as Ce}from"./formWatch-KqHO0hI-.js";import"./useInitFieldState-EKN-2KHT.js";const Ke=ee({__name:"YZTreedatabrowser",props:q({cfg:{},formRow:{}},{modelValue:{},modelModifiers:{}}),emits:q(["update:field"],["update:modelValue"]),setup(k,{emit:Z}){const{isEmpty:A,encode:P,encodeBase64:_}=ye(),{WatchChageExpress:j,WatchSelfExpress:L}=Ce(),{getFormEnv:W}=be(),Y=W(),{setFormValue:E,getFormValue:B,setDefaultCfgMapValue:w}=me(),g=ae(k,"modelValue"),h=V(g.value),n=k,a=V(n.cfg),S=V(!1),F=V(!1);te(async()=>{if(Y===oe.POST)await K(g.value);else{F.value=!0;try{await K(g.value),F.value=!1}catch(e){console.error(e),F.value=!1}}le(()=>{X(),L(a.value,n.formRow,e=>{g.value=e,h.value=e},e=>{a.value.hidden=e,y("update:field",a.value)},e=>{a.value.disabled=e,y("update:field",a.value)},e=>{a.value.hidden=e,y("update:field",a.value)})})}),se(()=>g.value,(e,o)=>{e&&(j(n.cfg,e,n.formRow),h.value=e,K(e))});const z=()=>{n.cfg.disabled||(S.value=!0)},I=e=>{S.value=e},G=()=>{I(!1)},J=e=>{I(!1),Q(e)},Q=async e=>{const o=n.cfg;if(e.length<=0)return;const l=o.multiSelect;if(!o.ds)return;const u=o.ds,r=o.ds.map,f=Object.keys(r);if(l){const m=u.valueField;if(m){const t=e.map(d=>d.extend[m]).join(",");g.value=t,h.value=t}f.forEach(t=>{const d=t,p=r[t],c=e.map(s=>s.extend[d]).join(",");E(n.cfg,p,c)}),f.forEach(t=>{const d=t,p=r[t],c=e.map(s=>s.extend[d]).join(",");w(p,c)})}else{let m="";const t=e[0],d=u.valueField;if(d){const v=t.extend[d];m=v,g.value=v,h.value=v}if(f.forEach(v=>{const C=v,N=r[v],$=t.extend[C];E(n.cfg,N,$)}),f.forEach(v=>{const C=v,N=r[v],$=t.extend[C];w(N,$)}),!n.cfg.valueConvertDs)return;const c=O(o.valueConvertDs),s=D(o.valueConvertDs,m);await R(c,s,o.valueConvertDs)}},O=e=>e?e.type==M.table&&e.dataSourceId&&e.tableName?T.getTableDatSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName}):e.type==M.esb&&e.dataSourceId?T.getEsbDataSourceNoPage.url.toFetchUrl({params1:e.dataSourceId}):e.type==M.form&&e.dataSourceId&&e.tableName?T.getFormDataSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName}):"":"",D=(e,o)=>{const l=new FormData;if(!e)return l;const u={};u[e.valueField]={op:"=",value:o};const r=Object.keys(e.filter);r.length>0&&r.forEach(c=>{const s=e.filter[c];s.type==="const"?u[c]={op:s.op,value:s.value}:u[c]={op:s.op,value:B(n.cfg,s.value)}});const f=[],m=Object.keys(e.map);m.length>0&&m.forEach(c=>{f.push(c)});const t=_(P(u));l.append("f",t);const d=_(P(f));l.append("c",d);let p=e.orderBy;return p&&(p=_(e.orderBy)),l.append("o",p),l},R=async(e,o,l)=>{if(!l)return;const{success:u,errorMessage:r,data:f}=await pe(e,o);if(!u)ve(r,"danger");else if(f&&f instanceof Array&&f.length>0){const m=f[0],t=l.displayField;h.value=String(m[t]);const d=l.map;Object.keys(d).forEach(p=>{const c=m[p],s=d[p];if(F.value){const v=B(n.cfg,s),C=n.formRow[s];(A(v)||C!=v)&&E(n.cfg,s,c)}else E(n.cfg,s,c)}),Object.keys(d).forEach(p=>{const c=m[p],s=d[p];w(s,c)})}},K=async(e=null)=>{const o=n.cfg;if(h.value=e,!!o.ds&&o.valueConvertDs){let l=g.value;e&&(l=e);const u=O(o.valueConvertDs),r=D(o.valueConvertDs,l);await R(u,r,o.valueConvertDs)}},y=Z,U=V(""),X=()=>{const e=a.value,o=`setDisabled_${e.uuid}_${e.fullKey}`,l=`setHidden_${e.uuid}_${e.fullKey}`,u=`setColumnHidden_${e.uuid}_${e.fullKey}`,r=`setRules_${e.uuid}_${e.fullKey}`,f=`autoActiveEvent_${e.uuid}_${e.fullKey}`,m=`setClose_${e.uuid}`;b.on(o,t=>{a.value.disabled=t,y("update:field",a.value)}),b.on(l,t=>{a.value.hidden=t,y("update:field",a.value)}),b.on(u,t=>{a.value.hidden=t,y("update:field",a.value)}),b.on(r,t=>{a.value.rules=[t],y("update:field",a.value)}),b.on(f,t=>{j(n.cfg,g.value,n.formRow)}),b.on(m,t=>{U.value=t})};return(e,o)=>{const l=H("van-field"),u=H("YZTreeDataDialog");return ge(),ne("div",{class:fe(i(U))},[re(ue("div",null,[x(l,{modelValue:i(h),"onUpdate:modelValue":o[0]||(o[0]=r=>ie(h)?h.value=r:null),"is-link":!i(a).disabled,readonly:"",name:i(a).bindModel,label:i(a).fieldLabel,placeholder:i(a).placeholder,disabled:i(a).disabled,required:i(a).required,rules:i(a).rules,onClick:z},{button:de(()=>[x(he,{field:i(a)},null,8,["field"])]),_:1},8,["modelValue","is-link","name","label","placeholder","disabled","required","rules"]),x(u,{showPicker:i(S),multiple:e.cfg.multiSelect,currentCfg:e.cfg,title:i(a).dialogTitle,ds:i(a).ds,treeCfg:i(a).treeConfig,onOnSave:J,onOnCancel:G},null,8,["showPicker","multiple","currentCfg","title","ds","treeCfg"])],512),[[ce,!i(a).hidden]])],2)}}});export{Ke as default};
