import{d as Z,L as z,D as q,M as Q,o as R,c as U,N as X,m as j,O as ee,a as ae,b,e as te,r as C,u as w,i as S,F as se,g as oe,k as ne,t as le,J as L,q as h,y as d,P as p,K as c,p as k}from"./main-BnXXyOo5.js";import{c as ie,C as re,S as _,a as D,u as me,_ as P}from"./wecom.prod-DVLinVsr.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue=Z({__name:"YZUploader",props:z({disabled:{type:Boolean},fileType:{},fileTypes:{},maxSize:{},size:{},fileListData:{},maxLimit:{}},{modelValue:{type:String},modelModifiers:{}}),emits:z(["afterUpload","onDelete"],["update:modelValue"]),setup(T,{emit:V}){q();const n=T,B={image:[{name:"拍照",text:"Camera"},{name:"上传图片",text:"image"}],files:[{name:"上传文件",text:"file"}]},I=Q(T,"modelValue");R(async()=>{if(I.value){let e=I.value.split(",");const o=new FormData;e.forEach(a=>{o.append("fileIds",a)})}});const m=U({get(){return n.fileListData},set(e){}}),f=V,A=e=>{if(Array.isArray(e)){const o=e.map(a=>{const t=new FormData;return a.status="uploading",a.message="上传中...",t.append("file",a.file),L(h.uploadAttachment.url,t)});Promise.all(o).then(a=>{a.forEach(t=>{const{data:s}=t;f("afterUpload",s)})})}else{const o=new FormData;e.status="uploading",e.message="上传中...",o.append("file",e.file),L(h.uploadAttachment.url,o).then(({data:a})=>{e.status="done",e.message="上传完成",f("afterUpload",a)}).catch(a=>{e.status="failed",e.message=d("Form.UploadFail"),console.error("error",a)})}},$=U(()=>n.fileType==="image"?"image/*":"*"),E=e=>{if(n.fileType==="files"){let o=n.maxSize?parseInt(n.maxSize):0,a=n.size||"MB",t="";if(n.size==="MB"){const s=e.size/1024/1024,l=Math.round(s*100)/100;if(o>=l)return!1;t=l+n.size}else if(a==="GB"){const s=e.size/1024/1024/1024,l=Math.round(s*100)/100;if(o>=l)return!1;t=l+a}else if(a==="KB"){const s=e.size/1024,l=Math.round(s*100)/100;if(o>=l)return!1;t=l+a}return p({type:"danger",message:`上传的文件大小超出限制，限制【${o}${a}】，实际文件【${t}】`}),!0}return!1},N=e=>{if(m.value.find(t=>t.name===e.name&&t.size===e.size))return p({type:"danger",message:"请勿重复上传相同的文件"}),!1;let a=n.fileTypes||"*.*";if(a!="*.*"){let t=e.name.split(".")[e.name.split(".").length-1];if(!a.replaceAll("*.","").split(";").filter(l=>l).includes(t))return p({type:"danger",message:`因文件类型不符，禁止上传附件：${e.name}此处仅允许上传以下后缀的附件：${a}`}),!1}return typeof n.maxLimit=="number"&&m.value.length>=n.maxLimit?(p({type:"danger",message:d("Form.uploadLimit",{count:n.maxLimit})}),!1):!0},v=X("uploaderRef"),G=()=>{y.value=!0},y=j(!1),x=ee(),H=async(e,o)=>{var a,t,s;e.text==="file"?(a=v.value)==null||a.chooseFile():x==="H5"?(t=v.value)==null||t.chooseFile():x==="WECHAT"?await K(e.text):x==="DINGTALK"?await O(e.text):x==="FEISHU"?await W(e.text):x==="UNIAPP"&&((s=v.value)==null||s.chooseFile())},J=()=>{y.value=!1},K=async e=>{if(typeof n.maxLimit=="number"&&m.value.length>=n.maxLimit){p({type:"danger",message:d("Form.uploadLimit",{count:n.maxLimit})});return}let o=10;typeof n.maxLimit=="number"&&(o=n.maxLimit-m.value.length);const a=await ie({count:o,sizeType:[D.original,D.compressed],sourceType:e==="Camera"?[_.camera]:[_.album],defaultCameraMode:re.batch});if(a.errCode!==0){c(a.errMsg,"danger");return}const t=a.localIds,s=[];for(let r=0;r<t.length;r++){const M=me({localId:t[r],isShowProgressTips:!0});s.push(M)}const l=await Promise.all(s),i=t.length,g=l.filter(r=>r.errCode===0).length;if(i!==g){c(`上传素材失败${i-g}个文件`,"danger");return}const u=l.map(r=>L(h.UploadImageForWechat.url+"?serverId="+r.serverId,{}));Promise.all(u).then(r=>{console.log("result",r),r&&r.length>0?r.map(F=>F.data).forEach(F=>{f("afterUpload",F)}):c("上传失败","danger")})},O=e=>{if(typeof n.maxLimit=="number"&&m.value.length>=n.maxLimit){p({type:"danger",message:d("Form.uploadLimit",{count:n.maxLimit})});return}let o=9;return typeof n.maxLimit=="number"&&(o=n.maxLimit-m.value.length),new Promise((a,t)=>{e==="Camera"?P.biz.util.uploadImageFromCamera({compression:!1}).then(s=>{if(s&&s.length>0){const l=s[0];k(h.dingTalkUploadImg.url,{url:l}).then(i=>{i.success?f("afterUpload",i.data):c(i.errorMessage,"danger")})}else c("拍照失败","danger"),t({msg:"拍照失败"})}):P.biz.util.uploadImage({multiple:!0,max:o,compression:!1}).then(s=>{if(s&&s.length>0){const l=s.map(i=>k(h.dingTalkUploadImg.url,{url:i}));Promise.all(l).then(i=>{i&&i.length>0?i.map(u=>u.data).forEach(u=>{f("afterUpload",u)}):(c("上传失败","danger"),t({msg:"上传失败"}))})}else c("拍照失败","danger"),t({msg:"拍照失败"})}).catch(s=>{c("上传失败","danger"),t({msg:"上传失败"})})})},W=async e=>{let o=10;if(typeof n.maxLimit=="number"&&(o=n.maxLimit-m.value.length),typeof n.maxLimit=="number"&&m.value.length>=n.maxLimit){p({type:"danger",message:d("Form.uploadLimit",{count:n.maxLimit})});return}window.tt.chooseImage({sourceType:e==="Camera"?["camera"]:["album"],count:o,cameraDevice:"back",success:async function(a){const{tempFilePaths:t}=a;for(let s=0;s<t.length;s++){const l=t[s];window.tt.getFileSystemManager().readFile({filePath:l,encoding:"base64",success:async g=>{const{success:u,data:r}=await Y(g.data);u?f("afterUpload",r):c(d("Form.UploadFail"),"danger")},fail(g){c(`${d("Form.FileRead")}`,"danger")}})}}})},Y=e=>new Promise((o,a)=>{const t=e.indexOf("base64")>-1?e:"data:image/jpeg;base64,"+e,s=".jpeg",l=new Date().getTime().toString()+s;L(h.updateBase64.url,{fileName:l,fileExt:s,fileContent:t}).then(i=>{o(i)}).catch(i=>{a(i)})});return(e,o)=>{const a=C("van-button"),t=C("van-uploader"),s=C("van-action-sheet");return oe(),ae(se,null,[b(a,{icon:"plus",type:"primary",disabled:e.disabled,size:"small",onClick:G},{default:te(()=>[ne(le(e.fileType==="image"?e.$t("Form.UploadImg"):e.$t("Form.UploadFile")),1)]),_:1},8,["disabled"]),b(t,{modelValue:w(m),"onUpdate:modelValue":o[0]||(o[0]=l=>S(m)?m.value=l:null),style:{display:"none"},"preview-image":!1,"preview-full-image":!1,ref_key:"uploaderRef",ref:v,"before-read":N,"after-read":A,"max-count":n.maxLimit,accept:w($),"max-size":E},null,8,["modelValue","max-count","accept"]),b(s,{show:w(y),"onUpdate:show":o[1]||(o[1]=l=>S(y)?y.value=l:null),"cancel-text":e.$t("Global.Cancle"),onCancel:J,"close-on-click-action":"","close-on-click-overlay":!1,actions:B[e.fileType],onSelect:H},null,8,["show","cancel-text","actions"])],64)}}}),ge=ce(ue,[["__scopeId","data-v-08daa24b"]]);export{ge as default};
