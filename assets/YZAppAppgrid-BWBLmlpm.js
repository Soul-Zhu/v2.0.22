import{d as J,m as l,o as K,x as O,c as Y,a as c,b as x,e as C,i as P,u,r as k,H as D,J as Z,K as $,g as f,F as A,j as I,h as V,k as Q,t as B}from"./main-BnXXyOo5.js";import{u as W}from"./encodeext-DBC3bVZy.js";import{u as X}from"./useDataParams-CrPFuV8M.js";import{A as ee}from"./appurl-DnExzjDg.js";const ae={class:""},re=J({__name:"YZAppAppgrid",props:{appcfg:{},formRow:{}},setup(T){const{getParams:E,getSchema:F}=X(),{encode:y,encodeBase64:S}=W(),i=l(!1),g=l(!1),d=l(1),r=T;l(r.appcfg),K(()=>{O(async()=>{await R(),await h()})});const L=Y(()=>r.appcfg.gridSettingColumns),m=l([]),b=l(0),v=l(!1),_=l([]),N=l([]),R=async()=>{_.value=await E(r.appcfg.ds),N.value=await F(r.appcfg.ds)},U=async()=>{v.value&&(m.value.length=0,v.value=!1);const a=M(r.appcfg.ds);await q(r.appcfg.ds,a)},G=a=>a&&a.type===D.table?ee.getAppGridDataSourceTable.url.toFetchUrl({params1:a.dataSourceId,params2:a.tableName}):"",M=a=>{const e=new FormData;e.append("page",String(d.value)),e.append("limit",String(r.appcfg.pageSize));const s=(d.value-1)*r.appcfg.pageSize;if(e.append("start",String(s)),e.append("o",""),e.append("o",""),!a)return e;const o={};a.filter&&Object.keys(a.filter).forEach(t=>{const p=a.filter[t];o[t]={op:p.op,value:p.type==="const"?p.value:""}}),e.append("f",S(y(o)));const n=j(a);return e.append("lc",S(y(n))),e},j=a=>{const e=a.filter,s=[],o=_.value;for(const t of o){const p={...t};e&&t.name in e||a.type==D.table&&!z(r.appcfg.gridSettingColumns,t.name)||s.push(p)}const n=[];return s.forEach(t=>{t.dataType==="String"&&n.push(t.name)}),n},z=(a,e)=>{const s=a.find(o=>o.dataIndex==e);return s||null},q=async(a,e)=>{if(!a)return;const s=G(a),{success:o,errorMessage:n,data:t}=await Z(s,e);if(!o){$(n,"danger");return}b.value=t.total,(t.children.length<=0||b.value===m.value.length)&&(g.value=!0),i.value=!1,m.value.push(...t.children),d.value+=1},H=()=>{d.value=1,g.value=!1,v.value=!0,i.value=!0,h()},h=async()=>{await U()};return(a,e)=>{const s=k("van-list"),o=k("van-pull-refresh");return f(),c("div",ae,[x(o,{modelValue:u(i),"onUpdate:modelValue":e[1]||(e[1]=n=>P(i)?i.value=n:null),onRefresh:H},{default:C(()=>[x(s,{loading:u(i),"onUpdate:loading":e[0]||(e[0]=n=>P(i)?i.value=n:null),finished:u(g),"finished-text":"没有更多了","immediate-check":!1,onLoad:h},{default:C(()=>[(f(!0),c(A,null,I(u(m),(n,t)=>(f(),c("div",{class:"app-grid-card",key:t},[(f(!0),c(A,null,I(u(L),(p,w)=>(f(),c("div",{class:"app-grid-row",key:w},[V("p",null,[Q(B(p.text)+": ",1),V("span",null,B(n[p.$bind]),1)])]))),128))]))),128))]),_:1},8,["loading","finished"])]),_:1},8,["modelValue"])])}}});export{re as default};
