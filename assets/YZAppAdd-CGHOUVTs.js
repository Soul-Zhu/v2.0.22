import{d as X,c as ee,W as te,m as c,q as M,p as oe,K as f,Y as ae,N as re,a as N,b as g,e as B,i as ne,u as s,r as S,g as D,h as O,n as P,y as v,k as se,t as ie,J as ce,a0 as de,a1 as me}from"./main-BnXXyOo5.js";import{u as ue,a as le,b as fe,_ as pe,c as ge}from"./useDefaultRow-Bhv6lFSR.js";import{u as ve}from"./useClearnForm-ePekKxJW.js";import{u as we}from"./heightValidate-C1QXqfrl.js";import{u as _e}from"./formStore-Byb73AL_.js";import{_ as Fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./LoginFactory-C2TRmDIo.js";import"./wecom.prod-DVLinVsr.js";import"./dynamic-import-helper-BheWnx7M.js";import"./useInitFieldState-EKN-2KHT.js";import"./formWatch-KqHO0hI-.js";import"./useFormEnv-VwQXjqJl.js";import"./encodeext-DBC3bVZy.js";const he={class:""},Ie={class:"grid-add-container"},Ce={class:"grid-add-title"},Re={key:0,class:"grid-add-form"},be={key:1,class:"grid-add-button"},Ne=X({__name:"YZAppAdd",props:{appName:{},show:{type:Boolean},fmid:{}},emits:["onClose","onSave"],setup(T,{emit:U}){const{parseSrcModel:V,parseSrcComponent:E}=ue(),{createControlConfig:G}=le(),{createDefaultRow:Y}=fe(),w=T,_=U,F=ee({get(){return w.show&&Z(w.fmid),w.show},set(o){_("onClose",o)}}),$=()=>{x(),_("onClose",!1)},e=te(),H=_e(),p=c({}),y=c({}),h=c([]),I=c(!1),C=c(""),k=c("");me("formData",p);const Z=async o=>{const a=M.getNewFormService.url.toFetchUrl({params1:o}),{success:n,errorMessage:i,data:d}=await oe(a);if(!n){f(i,"danger");return}const{app:t}=d;if(!t){f("没有找到表单","danger");return}C.value=t.appId,k.value=t.form.formId;const m=t.form.formId,r=`${e.getCurrentFormId}_${m}`;e.setRuningFormId(m),e.setRuningFormId(r),e.setRuningInitaotr(r,t.initiatorAccount),e.setRuningMember(r,t.memberId),e.setRuningOuId(r,t.ouid),e.setRuningOwnerAccount(r,t.ownerAccount),e.setRuningProviderName(r,t.providerName);const u=t.viewModel.data;u.rowId=ae(),u.rowPId="$$root";const b=await H.getFormDefined(m);if(b){const K=V(b.src),Q=E(K),l=await G(Q.definition,b,t.viewModel);p.value=l.cfgForm,y.value=Y(l.cfgForm),e.setRuningFormData(r,p.value),e.setRunningDefaultCfg(r,l.cfgs),l.plains.forEach(z=>{e.addRunningPlainCfg(r,z)}),h.value=l.cfgs,I.value=!0}},j=o=>{const a=e.getCurrentFormId;e.setRunningDefaultCfg(a,o),h.value=o},A=re("formRef"),{executeValidate:L}=we(),{clearFormData:W}=ve(),q=async()=>{const{renderRef:o}=A.value,a=await L({actionName:"",validationGroup:"",isDefaultTransition:!1,submitConfirm:!1});try{if(await o.validate(),a>0){const u=v("Form.validateMsg",{count:a});f(u,"danger");return}const n=W(p.value),d={header:{appId:C.value,formId:k.value,formState:"New"},formData:n},t=M.saveNewFormService.url.toFetchUrl({params1:C.value,params2:-1,params3:"New"}),{success:m,data:R,errorMessage:r}=await ce(t,d);if(!m){f(r,"danger");return}de({title:"提示",message:`提交成功！
 单据号: `+R.SN}).then(u=>{x(),_("onSave",R)})}catch(n){const i=v("Form.validateMsg",{count:n.length});f(i,"danger")}},{deleteFieldEventHandler:J}=ge(),x=()=>{const o=e.getCurrentFormId;if(o.indexOf("_")>0){J(),e.removeFormIdData(o);const a=o.split("_");a.pop();const n=a.join("_");e.setRuningFormId(n)}};return(o,a)=>{const n=S("YZNav"),i=S("van-button"),d=S("van-popup");return D(),N("div",he,[g(d,{show:s(F),"onUpdate:show":a[0]||(a[0]=t=>ne(F)?F.value=t:null),position:"bottom",teleport:"body"},{default:B(()=>[O("div",Ie,[O("div",Ce,[g(n,{title:o.appName,showBack:!0,leftText:s(v)("Global.Back"),onOnLeftClick:$,rightText:""},null,8,["title","leftText"])]),s(I)?(D(),N("div",Re,[g(pe,{cfg:s(h),ref_key:"formRef",ref:A,"form-row":s(y),"onUpdate:field":j},null,8,["cfg","form-row"])])):P("",!0),s(I)?(D(),N("div",be,[g(i,{type:"primary",onClick:q,block:""},{default:B(()=>[se(ie(s(v)("Global.New")),1)]),_:1})])):P("",!0)])]),_:1},8,["show"])])}}}),Ee=Fe(Ne,[["__scopeId","data-v-9f71b5b2"]]);export{Ee as default};
