const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./RecordPopup-DKCYEjJ4.js","./main-BnXXyOo5.js","./main-CVDmtNd4.css","./useFormEnv-VwQXjqJl.js","./_plugin-vue_export-helper-DlAUqK2U.js","./RecordPopup-TQTAKzRY.css"])))=>i.map(i=>d[i]);
import{A as Pe,m as c,E as De,c as be,D as ye,N as Ee,o as Te,Q as $,W as ke,y as q,K as D,a4 as Oe,q as ne,J as te,a0 as pe,aI as Ne,X as He,Z as he,aL as Me,d as Ue,w as Ae,a as ge,g as W,h as Z,b as _,s as ve,n as ae,e as z,u as r,r as re,aM as Ve,i as ie,f as Be,_ as xe,l as Le,v as je,t as $e,a1 as Re}from"./main-BnXXyOo5.js";import{c as qe,u as We,a as Ze,b as ze,_ as Ge}from"./useDefaultRow-Bhv6lFSR.js";import{u as Ye}from"./formEvent.hook-CPQy9-nk.js";import{u as Je,_ as Ke}from"./GobalPopup.vue_vue_type_script_setup_true_lang-IvsNKDOg.js";import{a as we}from"./app.hook-BvqEBUQR.js";import{u as Qe,F as Xe}from"./FormTool-uahxYRvh.js";import{u as eo}from"./heightValidate-C1QXqfrl.js";import{u as oo,P as so}from"./PostDialog-Cs01WTTG.js";import{u as no}from"./useProcessFormData-BB1RW82V.js";import{_ as to}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./LoginFactory-C2TRmDIo.js";import"./wecom.prod-DVLinVsr.js";import"./dynamic-import-helper-BheWnx7M.js";import"./useInitFieldState-EKN-2KHT.js";import"./formStore-Byb73AL_.js";import"./encodeext-DBC3bVZy.js";import"./useFormEnv-VwQXjqJl.js";import"./formWatch-KqHO0hI-.js";const{deleteEventHandler:F,deleteFormFieldEvent:ao,deleteExtendEventHandler:ro}=qe(),{getProcessInfoDefined:io,getFormDefined:co}=Qe(),{executeValidate:lo}=eo(),{formUtil:uo,initFormData:mo}=Je(),{createRequiredFlag:fo}=oo(),po=ye(),o=ke(),go=()=>{const ce=Pe(),p=c(""),b=c(""),I=c([]),u=c({}),v=c(!1),S=De(),U=c(""),y=c(""),E=c(!1),T=c(!1),A=c(!1),l=c(""),P=c(""),G=c(""),V=c({}),{parseSrcModel:Y,parseSrcComponent:k}=We(),{createControlConfig:J}=Ze(),{loadFetchEvent:B}=Ye(),{buildProcessFormData:K}=no(),{createDefaultRow:Q}=ze();let t=null;const w=be(()=>po.getApp),g=c(!1),x=async()=>{var de;const n=He();t=await B();const{stepId:a}=ce.params;P.value=String(a);const e=await io(String(a));if(!e)return;g.value=e.taskInstance.stepFinished,G.value=e.taskId;const s=e.form.formId;p.value=s,o.setRuningCurrentNodeName(s,e.activityName),o.setRuningCurrentNodeId(s,e.activityId),o.setRuningFormId(e.form.formId),o.setRuningProcessInfoDefined(e.form.formId,e),l.value=e.processName,b.value=e.processVersion,A.value=e.permisions.Consign;const m=await co(e.form.formId);if(o.setRuningSn(e.form.formId,e.processInstance.serialNum),o.setRuningStartTime(e.form.formId,e.processInstance.startTime),o.setRuningInitaotr(e.form.formId,e.processInstance.initiatorAccount),o.setRuningOwnerAccount(e.form.formId,e.processInstance.ownerAccount),e.processInstance.ouid){const i=e.processInstance.ouid.split("."),d=i[0],N=i[1];o.setRuningProviderName(e.form.formId,d),o.setRuningOuId(e.form.formId,N)}if(e.processInstance.ownerPosition){const i=e.processInstance.ownerPosition.split(".");o.setRuningMember(e.form.formId,i[1])}o.setRuningHeader(s,"draftId",""),o.setRuningHeader(s,"consignEnabled",!1),o.setRuningHeader(s,"consignReturnType","Return"),o.setRuningHeader(s,"consignRoutingType","Parallel"),o.setRuningHeader(s,"consignUsers",[]),o.setRuningHeader(s,"comments",""),o.setRuningHeader(s,"actionName",""),o.setRuningHeader(s,"context",{Routing:{}});const h=Y(m.src),f=k(h);if(fo(f.definition.components,e.actions),t&&t[l.value]){const i=t[l.value],d=i.funcs;if(d){const H=f.funcs;Object.keys(d).forEach(M=>{H[M]=d[M]}),o.setRuningFunctions(e.form.formId,H)}else o.setRuningFunctions(e.form.formId,d);const N=i.validators;if(N){const H=f.validators;Object.keys(N).forEach(M=>{H[M]=N[M]}),o.setRuningValidators(e.form.formId,H)}else o.setRuningValidators(e.form.formId,f.validators)}else o.setRuningFunctions(e.form.formId,f.funcs),o.setRuningValidators(e.form.formId,f.validators);const{cfgs:se,cfgForm:j,plains:C}=await J(f.definition,m,e.viewModel,he.PROCESS),fe=K(e.viewModel.data);if(V.value=Q(fe),u.value=fe,I.value=se,o.setRunningDefaultCfg(e.form.formId,I.value),o.setRuningFormData(e.form.formId,u.value),C.forEach(i=>{o.addRunningPlainCfg(e.form.formId,i)}),sessionStorage.setItem("env","process"),t&&t[l.value]){const i=t[l.value];await((de=i.onBeforeFormRender)==null?void 0:de.call(i,u.value,"PROCESS")),v.value=!0,mo(u.value),$.on("onProcess_getFormData",d=>{d(u.value)}),setTimeout(()=>{var d;(d=i.onAfterFormRender)==null||d.call(i,uo,"PROCESS")},2e3)}else $.on("onProcess_getFormData",i=>{i(u.value)}),v.value=!0;if(t&&t[l.value]){const i=t[l.value];i.onMounted&&i.onMounted.call(i,"POST")}n&&n.remove()},X=()=>{we(S)},O=()=>{T.value=!1},R=Ee("formRef"),le=c(""),ue=c(),ee=c();Te(async()=>{$.on("onForm_Agreen",async n=>{o.setRuningHeader(p.value,"actionName",n.actionName);const{renderRef:a}=R.value;if(t&&t[l.value]){const s=t[l.value];if(s&&s.onBeforeValidate&&!await s.onBeforeValidate.call(t,u.value,a,"PROCESS"))return}const e=await lo(n);try{if(await a.validate(),e>0){const s=q("Form.validateMsg",{count:e});D(s,"danger");return}if(t&&t[l.value]){const s=t[l.value];if(s&&s.onAfterValidate&&!await s.onAfterValidate.call(t,u.value,a,"PROCESS"))return}ue.value=n,T.value=!0}catch(s){if(s.length>0){const m=q("Form.validateMsg",{count:s.length});D(m,"danger");return}}}),$.on("onForm_ProcessSave",async()=>{const n={formData:Oe.cloneDeep(u.value),header:{comments:""}};Object.keys(n.formData).forEach(e=>{e||delete n.formData[e]});const a=ne.processSave.url.toFetchUrl({params1:P.value});te(a,n).then(e=>{const{success:s,data:m,errorMessage:h}=e;if(O(),!s){D(h,"danger");return}s&&pe({title:q("Form.TipTitle"),message:q("Form.SaveSuccess")})})}),await x()});const Ce=async n=>{const a=ue.value;if(ee.value=n,a)if(a.submitConfirm&&a.submitConfirm!=="None"){if(a.submitConfirm==="Prompt"){if(!await _e(String(a.promptMessage)))return;await L(n)}a.submitConfirm==="EnterPassword"&&(U.value=`您选择了 "${a.actionName}",执行本处理需要验证用户密码。`,le.value="提交验证",E.value=!0)}else await L(n);else await L(n)},L=n=>{o.setRuningHeader(p.value,"comments",n.comment),o.setRuningHeader(p.value,"consignRoutingType",n.consignRoutingType),o.setRuningHeader(p.value,"consignReturnType",n.consignReturnType),o.setRuningHeader(p.value,"consignEnabled",n.openConsign),o.setRuningHeader(p.value,"context",n.context);const a=o.getRuningHeader(p.value);n.openConsign&&n.signUsers&&(a.consignUsers=n.signUsers.split(","));const e=ne.processSubmit.url.toFetchUrl({params1:P.value}),s={formData:u.value,header:a};if(t&&t[l.value]){const m=t[l.value];m&&m.onBeforeFormSubmit?m.onBeforeFormSubmit.call(t,u.value,"PROCESS").then(h=>{h&&oe(e,s)}):oe(e,s)}else oe(e,s)},oe=(n,a)=>{te(n,a).then(e=>{const{success:s,data:m,errorMessage:h}=e;if(O(),s){const{SN:f,Accounts:se}=m;if(t&&t[l.value]){const C=t[l.value];C&&C.onAfterFormSubmit&&C.onAfterFormSubmit.call(t,u.value,"PROCESS")}let j=`提交已成功!
业务流水号: ${f}
您提交的表单已传送给: ${se.map(C=>C.DisplayName).join(",")}
窗口将被关闭。`;m.PostResult==="TaskFinishedApproved"?j=`提交已成功!
业务流水号: ${f}
 流程已结束（批准)。
窗口将被关闭。`:m.PostResult==="TaskFinishedRejected"&&(j=`提交已成功!
业务流水号: ${f}
 流程已结束（拒绝)。
窗口将被关闭。`),pe({title:"提交成功",message:j}).then(()=>{we(S)})}else D(h,"danger")})},_e=async n=>new Promise((a,e)=>{Me({title:"提交确认",message:n}).then(()=>{a(!0)}).catch(s=>{a(!1)})}),Fe=async()=>{if(!y.value)return;const{success:n,data:a,errorMessage:e}=await te(ne.submitCheckAuth.url,{p:btoa(y.value)});if(!n){D(e,"danger");return}if(!a.pass){D("密码不正确","danger");return}ee.value&&await L(ee.value)},Ie=()=>{E.value=!1},me=c(!1),Se=()=>{me.value=!0};return Ne(()=>{const n=o.getCurrentFormId;ao(!0),ro(!0),F("onForm_MoreClose",!0),F("onForm_Agreen",!0),F("onForm_ProcessRead",!0),F("onForm_PostSubmit",!0),F("onForm_DraftSubmit",!0),F("onMapCfg_Update",!0),F("onForm_ProcessSave",!0),o.removeFormIdData(n)}),{init:x,formData:u,fields:I,render:v,onLeftClick:X,showTip:U,password:y,showPass:E,showConsin:A,showContent:T,onCanlePost:O,onConfirmPost:Ce,onConfirm:Fe,onCancel:Ie,formRef:R,processName:l,dialogTitle:le,moreShow:me,onMoreClick:Se,app:w,isComplete:g,formRow:V}},vo={class:"post-main"},Ro={class:"post-header"},wo={key:0,class:"post-form"},ho={class:"post-button"},Co={class:"pass-tip"},_o={class:"showTip"},Fo=Ue({__name:"process",setup(ce){const{onLeftClick:p,render:b,fields:I,showTip:u,password:v,showPass:S,showConsin:U,showContent:y,onCanlePost:E,onConfirmPost:T,onConfirm:A,onCancel:l,formData:P,formRef:G,processName:V,dialogTitle:Y,moreShow:k,onMoreClick:J,app:B,isComplete:K,formRow:Q}=go();Re("formData",P),Re("formField",I),Ae(P,(w,g)=>{window.formDataBase=w},{deep:!0});const t=Be(()=>xe(()=>import("./RecordPopup-DKCYEjJ4.js").then(w=>w.b),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url));return(w,g)=>{const x=re("van-icon"),X=re("YZNav"),O=re("van-field");return W(),ge("div",vo,[Z("div",Ro,[_(X,{title:r(V),leftText:w.$t(r(B)?"Global.Close":"Global.Back"),showBack:!r(B),onOnLeftClick:r(p),rightText:""},{right:z(()=>[_(x,{name:"more-o",size:"22",onClick:r(J)},null,8,["onClick"])]),_:1},8,["title","leftText","showBack","onOnLeftClick"])]),_(Ve,{name:"van-slide-left"},{default:z(()=>[r(b)?(W(),ge("div",wo,[_(Ge,{cfg:r(I),ref_key:"formRef",ref:G,formRow:r(Q)},null,8,["cfg","formRow"])])):ae("",!0)]),_:1}),Z("div",ho,[r(b)&&!r(K)?(W(),ve(Xe,{key:0,env:r(he).PROCESS},null,8,["env"])):ae("",!0)]),_(so,{show:r(y),consign:r(U),"onUpdate:show":r(E),"onUpdate:confirm":r(T)},null,8,["show","consign","onUpdate:show","onUpdate:confirm"]),_(Ke,{show:r(S),"onUpdate:show":g[1]||(g[1]=R=>ie(S)?S.value=R:null),title:r(Y),onOnConfirm:r(A),onOnCancel:r(l)},{tip:z(()=>[Z("div",Co,$e(r(u)),1)]),field:z(()=>[_(O,{modelValue:r(v),"onUpdate:modelValue":g[0]||(g[0]=R=>ie(v)?v.value=R:null),type:"password",label:"请输入密码",placeholder:"请输入密码",required:""},null,8,["modelValue"]),Le(Z("span",_o,"请输入您的密码",512),[[je,!r(v)]])]),_:1},8,["show","title","onOnConfirm","onOnCancel"]),r(b)?(W(),ve(r(t),{key:0,"more-show":r(k),"onUpdate:moreShow":g[2]||(g[2]=R=>ie(k)?k.value=R:null)},null,8,["more-show"])):ae("",!0)])}}}),Lo=to(Fo,[["__scopeId","data-v-7d3518cc"]]);export{Lo as default};
