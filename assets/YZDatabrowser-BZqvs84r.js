import{d as W,L as K,M as Y,m as b,o as z,Z as G,x as J,w as Q,Q as y,a as X,l as ee,v as ae,u,h as te,b as x,s as oe,e as se,i as le,r as U,G as ne,H as E,q as S,I as ue,J as re,K as ce,g as O,P as ie,y as de}from"./main-BnXXyOo5.js";import{_ as fe}from"./YZChangeFieldTag.vue_vue_type_style_index_0_lang-CU_sMXjx.js";import{u as me}from"./encodeext-DBC3bVZy.js";import{u as pe}from"./useFormEnv-VwQXjqJl.js";import{u as ve}from"./formWatch-KqHO0hI-.js";import{u as ge}from"./YZDataDialoglogic-BIEYZU0n.js";import"./useInitFieldState-EKN-2KHT.js";import"./useDataParams-CrPFuV8M.js";const Ee=W({__name:"YZDatabrowser",props:K({cfg:{},formRow:{}},{modelValue:{type:String},modelModifiers:{}}),emits:K(["update:field"],["update:modelValue"]),setup(N,{emit:R}){const{setFormValue:V,setDefaultCfgMapValue:F,getFormValue:L}=ue(),{WatchChageExpress:$,WatchSelfExpress:T}=ve();ge();const{encode:k,encodeBase64:w}=me(),{getFormEnv:q}=pe(),D=q(),m=Y(N,"modelValue"),p=b(m.value),c=N,a=b(c.cfg),_=b(!1);z(async()=>{D===G.POST?await C(m.value):m.value&&await C(m.value),J(()=>{A(),T(a.value,c.formRow,e=>{m.value=e,p.value=e},e=>{a.value.hidden=e,h("update:field",a.value)},e=>{a.value.disabled=e,h("update:field",a.value)},e=>{a.value.hidden=e,h("update:field",a.value)})})}),Q(()=>m.value,async(e,t)=>{e&&($(c.cfg,e,c.formRow),await C(e))});const H=()=>{if(!c.cfg.disabled){if(!c.cfg.ds){ie({type:"danger",message:de("Form.unConfigDs")});return}_.value=!0}},P=e=>{_.value=e},Z=async e=>{const t=c.cfg;if(!t.ds)return;const l=t.ds.map,n=Object.keys(l),d=t.ds.valueField;if(c.cfg.multiSelect){n.forEach(o=>{const s=e.map(f=>f[o]).join(","),i=l[o];V(c.cfg,i,s)});const r=String(e.map(o=>o[d]).join(","));m.value=r,p.value=r,n.forEach(o=>{const s=e.map(f=>f[o]).join(","),i=l[o];F(i,s)})}else{n.forEach(o=>{const s=e[o],i=l[o];V(c.cfg,i,s)}),n.forEach(o=>{const s=e[o],i=l[o];F(i,s)});const r=String(e[d]);if(m.value=r,p.value=r,t.valueConvertDs){const o=M(t.valueConvertDs),s=B(t.valueConvertDs,r);await j(o,s,t.valueConvertDs)}}P(!1)},M=e=>e?e.type==E.table&&e.dataSourceId&&e.tableName?S.getTableDatSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName}):e.type==E.esb&&e.dataSourceId?S.getEsbDataSourceNoPage.url.toFetchUrl({params1:e.dataSourceId}):e.type==E.form&&e.dataSourceId&&e.tableName?S.getFormDataSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName}):"":"",B=(e,t)=>{const l=new FormData;if(!e)return l;const n={};n[e.valueField]={op:"=",value:t};const d=Object.keys(e.filter);d.length>0&&d.forEach(v=>{const g=e.filter[v];g.type==="const"?n[v]={op:g.op,value:g.value}:n[v]={op:g.op,value:L(c.cfg,g.value)}});const r=[],o=Object.keys(e.map);o.length>0&&o.forEach(v=>{r.push(v)});const s=w(k(n));l.append("f",s);const i=w(k(r));l.append("c",i);let f=e.orderBy;return f&&(f=w(e.orderBy)),l.append("o",f),l},j=async(e,t,l)=>{if(!l)return;const{success:n,errorMessage:d,data:r}=await re(e,t);if(!n)p.value=m.value,ce(d,"danger");else if(r&&r instanceof Array&&r.length>0){const o=r[0],s=l.displayField;p.value=String(o[s]);const i=l.map;Object.keys(i).forEach(f=>{const v=o[f],g=i[f];V(c.cfg,g,v)}),Object.keys(i).forEach(f=>{const v=o[f],g=i[f];F(g,v)})}},C=async(e=null)=>{const t=c.cfg;if(p.value=e,!!t.ds&&t.valueConvertDs){const l=M(t.valueConvertDs);let n=m.value;e&&(n=e);const d=B(t.valueConvertDs,n);await j(l,d,t.valueConvertDs)}},h=R,I=b(""),A=()=>{const e=a.value,t=`setDisabled_${e.uuid}_${e.fullKey}`,l=`setHidden_${e.uuid}_${e.fullKey}`,n=`setColumnHidden_${e.uuid}_${e.fullKey}`,d=`setRules_${e.uuid}_${e.fullKey}`,r=`autoActiveEvent_${e.uuid}_${e.fullKey}`,o=`setClose_${e.uuid}`;y.on(t,s=>{a.value.disabled=s,h("update:field",a.value)}),y.on(l,s=>{a.value.hidden=s,h("update:field",a.value)}),y.on(n,s=>{a.value.hidden=s,h("update:field",a.value)}),y.on(d,s=>{a.value.rules=[s],h("update:field",a.value)}),y.on(r,s=>{$(c.cfg,m.value,c.formRow)}),y.on(o,s=>{I.value=s})};return(e,t)=>{const l=U("van-field"),n=U("YZDataDialog");return O(),X("div",{class:ne(u(I))},[ee(te("div",null,[x(l,{modelValue:u(p),"onUpdate:modelValue":t[0]||(t[0]=d=>le(p)?p.value=d:null),"is-link":!u(a).disabled,readonly:"",name:u(a).bindModel,rules:u(a).rules,label:u(a).fieldLabel,placeholder:u(a).placeholder,disabled:u(a).disabled,required:u(a).required,onClick:H},{button:se(()=>[x(fe,{field:u(a)},null,8,["field"])]),_:1},8,["modelValue","is-link","name","rules","label","placeholder","disabled","required"]),(O(),oe(n,{showPicker:u(_),title:u(a).dialogTitle,ds:u(a).ds,currentField:u(a),viewColumns:u(a).viewColumns,onUpdatePicker:P,multiple:u(a).multiSelect,"onUpdate:field":Z,key:Math.random()},null,8,["showPicker","title","ds","currentField","viewColumns","multiple"]))],512),[[ae,!u(a).hidden]])],2)}}});export{Ee as default};
