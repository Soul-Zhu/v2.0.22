import{d as Se,c as Fe,m as v,w as xe,a as h,b as s,e as c,i as I,u as d,r as m,g as u,h as n,t as f,l as M,v as H,F as $,j as T,n as A,k as B,G as Ve,s as U,H as Q,q as W,I as Le,J as Ie,K as Be}from"./main-BnXXyOo5.js";import{u as De}from"./useDataParams-CrPFuV8M.js";import{u as $e}from"./encodeext-DBC3bVZy.js";const Te={class:""},Ue={class:"tree-pop-div"},Pe={class:"tree-pop-bar",id:"pop-bar"},ze={class:"right-box"},Re={class:"data-content"},Ye={class:"search-box"},Ze={class:"panel-body"},Ee={class:"crumbs"},Ge={class:"textspan"},Me=["onClick"],He={class:"textspan"},Oe={class:"depat-content"},je={key:0},qe={class:"dep-name"},Je={class:"a-icon"},Ke=["onClick"],Ae={key:1},Qe={class:"dep-name"},We={class:"a-icon"},Xe=["onClick"],et={key:0,class:"search-content"},tt={class:"dep-name"},ot={class:"a-icon"},at={key:1,class:"search-content"},lt={class:"dep-name"},nt={class:"a-icon"},st={class:"footer-box"},rt={class:"right-box"},ut=Se({__name:"YZTreeDataDialog",props:{showPicker:{type:Boolean,default:!1},title:{default:"数据选择"},ds:{default:null},multiple:{type:Boolean,default:!1},treeCfg:{default:null},currentCfg:{default:{}}},emits:["onSave","onCancel"],setup(ne,{emit:se}){const{getParams:re,getSchema:ce}=De(),{getFormValue:de}=Le(),{encodeBase64:O,encode:X}=$e(),i=ne,Z=Fe(()=>i.showPicker),P=v(""),V=v([{code:"root",text:"全部",parentId:""}]);v([]);const g=v([]),k=v(),ie=v([]),ue=v([]),C=v([]),ee=v(),z=v(""),D=v(!1),x=v([]),E=v([]),y=v([]),G=v(!1),te=async e=>{var t;if(z.value=e.code,(t=i.treeCfg)!=null&&t.treeLazyLoading){const o=j(i.ds),a=q(i.ds,e.code,`ZHYSoft.src.model9.TreeModel-${e.code}`),l=await J(o,a);K(l)}else y.value=C.value.filter(o=>o.parentId==e.code);pe(e)},pe=e=>{const t={code:e.code,text:e.text,parentId:e.parentId};ee.value=t,V.value.push(t)},ve=()=>{var e;V.value=[{code:"root",text:"全部",parentId:""}],z.value=String((e=i.treeCfg)==null?void 0:e.rootNodeCode)},me=e=>{var t;z.value=e.code,e.code!==((t=ee.value)==null?void 0:t.code)&&fe(e)},fe=async e=>{var w;const t=V.value,o=[];for(let p=0;p<t.length;p++){const N=t[p];if(N.code===e.code){o.push(N);break}else o.push(N)}V.value=o;const a=j(i.ds);let l=`ZHYSoft.src.model9.TreeModel-${e.code}`,_=e.code;if(e.code==="root"&&(l=e.code,_=""),i.treeCfg&&i.treeCfg.treeLazyLoading){const p=q(i.ds,_,l),N=await J(a,p);K(N)}else e.code==="root"&&(e.code=(w=i.treeCfg)==null?void 0:w.rootNodeCode),y.value=C.value.filter(p=>p.parentId==e.code)},_e=async()=>{ie.value=await re(i.ds),ue.value=await ce(i.ds)},j=e=>{let t="";return e?(e.type===Q.table&&e.dataSourceId&&e.tableName?t=W.getTableDatSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName}):e.type===Q.esb&&e.dataSourceId?t=W.getEsbDataSourceNoPage.url.toFetchUrl({params1:e.dataSourceId}):e.type===Q.form&&e.dataSourceId&&e.tableName&&(t=W.getFormDataSource.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName})),t):""},q=(e,t,o="root")=>{const a=new FormData;if(!e)return a;const l=i.treeCfg;if(!l)return a;const _={},w=Object.keys(e.filter);l.treeLazyLoading&&(t||(t=l.rootNodeCode),_[l.parentCodeFieldName]={op:"=",value:t}),w.length>0&&w.forEach(R=>{const L=e.filter[R];let Y=L.value;L.type==="field"&&(Y=de(i.currentCfg,L.value)),_[R]={op:L.op,value:Y}});const p=[],N=O(X(_));a.append("f",N);let F=e.orderBy;return F&&(F=O(e.orderBy)),a.append("o",F),l.treeLazyLoading||a.append("c",O(X(p))),l.treeLazyLoading&&a.append("node",o),a},he=async(e="")=>{const t=j(i.ds),o=q(i.ds,e),a=await J(t,o);a&&K(a)},J=async(e,t)=>{const{success:o,errorMessage:a,data:l}=await Ie(e,t);return o?l:(Be(a,"danger"),null)},K=e=>{if(e){if(G.value=!0,i.treeCfg){const{rootNodeCode:t}=i.treeCfg;z.value=String(t||-1);const o=i.treeCfg;if(!o)return;if(y.value.length=0,o.treeLazyLoading)for(const a of e){const l={parentId:a[o.parentCodeFieldName],code:a[o.codeFieldName],text:a[o.displayFieldName],extend:{...a}};C.value.find(w=>w.code===l.code)||C.value.push(l),y.value.push(l)}else y.value=e.filter(a=>a[o.parentCodeFieldName]==z.value).map(a=>({parentId:a[o.parentCodeFieldName],code:a[o.codeFieldName],text:a[o.displayFieldName],extend:{...a}})),C.value=ge(e)}G.value=!1}};xe(Z,async e=>{e&&(await _e(),await he())});const ge=e=>{if(!i.treeCfg)return[];const{codeFieldName:t,displayFieldName:o,parentCodeFieldName:a}=i.treeCfg;return e.map(l=>({code:String(l[t]),text:String(l[o]),parentId:String(l[a]),extend:{...l}}))},be=()=>{if(i.multiple){const e=g.value;if(e.length===0)return;x.value.length=0;for(let t=0;t<e.length;t++){const o=e[t],a=C.value.find(l=>l.code===o);a&&x.value.push(a)}}else{const e=k.value;if(!e)return;const t=C.value.find(o=>o.code===e);t&&(x.value=[t])}D.value=!0},ke=e=>{i.multiple?(g.value=g.value.filter(t=>t!==e.code),x.value=x.value.filter(t=>t.code!==e.code),x.value.length<=0&&(D.value=!1)):(k.value="",x.value.length=0,D.value=!1)},Ce=e=>{const t=String(e);E.value=C.value.filter(o=>o.text.indexOf(t)>-1)},oe=se,ye=()=>{oe("onCancel")},we=()=>{const e=[];if(i.multiple){const t=g.value;if(t.length===0)return;for(let o=0;o<t.length;o++){const a=t[o],l=C.value.find(_=>_.code==a);l&&e.push(l)}}else{const t=k.value;if(!t)return;const o=C.value.find(a=>a.code==t);o&&e.push(o)}oe("onSave",e)};return(e,t)=>{const o=m("YZNav"),a=m("van-search"),l=m("van-icon"),_=m("van-empty"),w=m("van-checkbox"),p=m("van-cell"),N=m("van-checkbox-group"),F=m("van-cell-group"),R=m("van-skeleton"),L=m("van-radio"),Y=m("van-radio-group"),ae=m("van-popup"),Ne=m("van-button");return u(),h("div",Te,[s(ae,{show:d(Z),"onUpdate:show":t[5]||(t[5]=S=>I(Z)?Z.value=S:null),position:"bottom"},{default:c(()=>{var S;return[n("div",Ue,[n("div",Pe,[s(o,{title:e.title,showBack:"",leftText:e.$t("Global.Back"),onOnLeftClick:ye,onClick:we},{right:c(()=>[n("div",ze,[n("span",null,f(e.$t("Global.Finish")),1)])]),_:1},8,["title","leftText"])]),n("div",Re,[n("div",Ye,[s(a,{modelValue:d(P),"onUpdate:modelValue":[t[0]||(t[0]=r=>I(P)?P.value=r:null),Ce],clearable:!1,placeholder:e.$t("Global.keywordsSearch")},null,8,["modelValue","placeholder"])]),M(n("div",Ze,[n("div",Ee,[n("div",{onClick:ve,class:"crumbs-item current"},[n("span",Ge,f((S=e.treeCfg)==null?void 0:S.rootNodeText),1),s(l,{name:"arrow"})]),(u(!0),h($,null,T(d(V),(r,b)=>(u(),h("div",{class:Ve(b<d(V).length-1?"crumbs-item current":"crumbs-item"),key:b,onClick:le=>me(r)},[n("span",He,f(r.text),1),b<d(V).length-1?(u(),U(l,{key:0,name:"arrow"})):A("",!0)],10,Me))),128))]),M(n("div",null,[s(_,{description:e.$t("Form.NoDepart")},null,8,["description"])],512),[[H,d(y).length==0]]),n("div",Oe,[d(y).length!=0&&e.multiple?(u(),h("div",je,[s(R,{title:"",avatar:"",row:3,loading:d(G)},{default:c(()=>[s(F,{border:""},{default:c(()=>[s(N,{modelValue:d(g),"onUpdate:modelValue":t[1]||(t[1]=r=>I(g)?g.value=r:null)},{default:c(()=>[(u(!0),h($,null,T(d(y),(r,b)=>(u(),U(p,{border:"",key:b},{title:c(()=>[n("div",null,[s(w,{name:r.code},{default:c(()=>[n("span",qe,[n("span",Je,[s(l,{name:"wap-home-o"})]),B(" "+f(r.text),1)])]),_:2},1032,["name"])])]),value:c(()=>[n("div",{class:"next-level",onClick:le=>te(r)},[s(l,{name:"ellipsis"}),n("span",null,f(e.$t("Form.NextLevle")),1)],8,Ke)]),_:2},1024))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["loading"])])):A("",!0),d(y).length!=0&&!e.multiple?(u(),h("div",Ae,[s(R,{title:"",avatar:"",row:3,loading:d(G)},{default:c(()=>[s(F,{border:""},{default:c(()=>[s(Y,{modelValue:d(k),"onUpdate:modelValue":t[2]||(t[2]=r=>I(k)?k.value=r:null)},{default:c(()=>[(u(!0),h($,null,T(d(y),(r,b)=>(u(),U(p,{border:"",key:b},{title:c(()=>[n("div",null,[s(L,{name:r.code},{default:c(()=>[n("span",Qe,[n("span",We,[s(l,{name:"wap-home-o"})]),B(" "+f(r.text),1)])]),_:2},1032,["name"])])]),value:c(()=>[n("div",{class:"next-level",onClick:le=>te(r)},[s(l,{name:"ellipsis"}),n("span",null,f(e.$t("Form.NextLevle")),1)],8,Xe)]),_:2},1024))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["loading"])])):A("",!0)])],512),[[H,!d(P)]]),M(n("div",null,[M(n("div",null,[s(_,{description:e.$t("Form.NoDepart")},null,8,["description"])],512),[[H,d(E).length==0]]),e.multiple?(u(),h("div",et,[s(F,{border:""},{default:c(()=>[s(N,{modelValue:d(g),"onUpdate:modelValue":t[3]||(t[3]=r=>I(g)?g.value=r:null)},{default:c(()=>[(u(!0),h($,null,T(d(E),(r,b)=>(u(),U(p,{border:"",key:b},{title:c(()=>[n("div",null,[s(w,{name:r.code},{default:c(()=>[n("span",tt,[n("span",ot,[s(l,{name:"wap-home-o"})]),B(" "+f(r.text),1)])]),_:2},1032,["name"])])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),_:1})])):(u(),h("div",at,[s(F,{border:""},{default:c(()=>[s(Y,{modelValue:d(k),"onUpdate:modelValue":t[4]||(t[4]=r=>I(k)?k.value=r:null)},{default:c(()=>[(u(!0),h($,null,T(d(E),(r,b)=>(u(),U(p,{border:"",key:b},{title:c(()=>[n("div",null,[s(L,{name:r.code},{default:c(()=>[n("span",lt,[n("span",nt,[s(l,{name:"wap-home-o"})]),B(" "+f(r.text),1)])]),_:2},1032,["name"])])]),_:2},1024))),128))]),_:1},8,["modelValue"])]),_:1})]))],512),[[H,d(P)]])]),n("div",st,[n("div",{class:"left-box",onClick:be},[s(l,{name:"arrow-up"})]),n("div",rt,[B(f(e.$t("Form.Checked"))+" ",1),n("b",null,"("+f(e.multiple?d(g).length:d(k)?1:0)+") ",1)])])])]}),_:1},8,["show"]),s(ae,{show:d(D),"onUpdate:show":t[6]||(t[6]=S=>I(D)?D.value=S:null),position:"bottom",round:"",style:{height:"50%"}},{default:c(()=>[s(F,null,{default:c(()=>[(u(!0),h($,null,T(d(x),S=>(u(),U(p,{key:S.code},{title:c(()=>[B(f(S.text),1)]),value:c(()=>[s(Ne,{size:"small",onClick:r=>ke(S)},{default:c(()=>[B(f(e.$t("Form.Remove")),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})]),_:1},8,["show"])])}}});export{ut as default};
