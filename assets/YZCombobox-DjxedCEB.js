import{d as ne,L as P,m as v,M as ue,W as ie,c as re,o as ce,x as de,at as b,Z as fe,Q as y,J as ve,K as me,au as pe,I as ge,w as he,a as be,l as ye,v as _e,u as r,h as Se,b as _,av as we,e as x,i as E,r as F,G as Fe,H as I,q as N,g as Ve,R as xe}from"./main-BnXXyOo5.js";import{_ as ke}from"./YZChangeFieldTag.vue_vue_type_style_index_0_lang-CU_sMXjx.js";import{u as Ce}from"./useFormEnv-VwQXjqJl.js";import{u as De}from"./formWatch-KqHO0hI-.js";import{u as Ee}from"./encodeext-DBC3bVZy.js";import{_ as Ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useInitFieldState-EKN-2KHT.js";const Ne=ne({__name:"YZCombobox",props:P({cfg:{},formRow:{}},{modelValue:{default:""},modelModifiers:{}}),emits:P(["update:field"],["update:modelValue"]),setup($,{emit:H}){const{isEmpty:T,encode:M,encodeBase64:k}=Ee(),{getFormValue:W,setFormValue:R,setDefaultCfgMapValue:L}=ge(),U=v(!1),o=ue($,"modelValue"),C=v(""),c=$,t=v(c.cfg),h=v(!1),d=v(""),f=v([]),D=v([]),O=v([]),{WatchChageExpress:Z,WatchSelfExpress:A}=De(),p=H,V=v(!1),G=ie(),Y=re(()=>G.getCurrentFormId);ce(async()=>{de(async()=>{V.value=!0,oe(),X();try{await j(),V.value=!1}catch(e){console.log(e),V.value=!1}A(t.value,c.formRow,e=>{o.value=e,d.value=g(e)},e=>{t.value.hidden=e,p("update:field",t.value)},e=>{t.value.disabled=e,p("update:field",t.value)},e=>{t.value.hidden=e,p("update:field",t.value)})})});const z=async()=>{t.value.disabled||(t.value.use===b.options?f.value=t.value.items.map(e=>({text:e.text,value:e.value})):await S(),h.value=!0)},g=e=>{if(t.value.use===b.ds){const a=f.value.find(l=>l.value==e);return a?String(a.text):e}else{const a=t.value.items.find(l=>l.value==e);return a?String(a.text):e}},j=async()=>{const e=t.value;console.log("ds",e.ds,e.bindModel);const{getFormEnv:a}=Ce();if(a()===fe.POST){if(o.value)if(e.use===b.options)d.value=g(o.value);else{await S();const s=g(o.value);d.value=s,w(o.value)}else if(e.use===b.options){const s=e.items.find(u=>u.checked);s&&(o.value=s.value,d.value=s.text)}else if(await S(),f.value.length>0&&o.value){const s=f.value.find(u=>u.value==o.value);s&&(o.value=String(s.value),d.value=String(s.text),w(String(s.value)))}}else if(o.value)if(e.use===b.options)d.value=g(o.value);else{await S();const s=g(o.value);d.value=s,w(o.value)}},J=e=>{const a=[];e.valueField&&a.push(e.valueField),e.displayField&&a.push(e.displayField),e.map&&Object.keys(e.map).length>0&&a.push(...Object.keys(e.map));const l=new FormData;l.append("c",k(M(a)));let s=e.orderBy;s&&(s=k(s)),l.append("o",s);let u={};return Object.keys(e.filter).length>0&&Object.keys(e.filter).forEach(i=>{const n=e.filter[i];u[i]={op:n.op,value:n.type==="const"?n.value:W(c.cfg,e.filter[i].value)}}),l.append("f",k(M(u))),l},Q=()=>{const e=c.cfg;if(!e.ds)return"";if(e.ds.type===I.table&&e.ds.dataSourceId&&e.ds.tableName)return N.getTableDatSource.url.toFetchUrl({params1:e.ds.dataSourceId,params2:e.ds.tableName});if(e.ds.type===I.esb&&e.ds.dataSourceId)return N.getEsbDataSourceNoPage.url.toFetchUrl({params1:e.ds.dataSourceId});if(e.ds.type===I.form&&e.ds.dataSourceId&&e.ds.tableName)return N.getFormDataSource.url.toFetchUrl({params1:e.ds.dataSourceId,params2:e.ds.tableName})},X=()=>{const e=c.cfg.ds;if(!e)return null;Object.keys(e.filter).length>0&&Object.keys(e.filter).forEach(a=>{const l=e.filter[a];if(l.type!=="const"){const u=`onField_Filter_${l.value}_${Y.value}`;y.on(u,ee)}})},ee=async()=>{const e=o.value,l=(await S()).find(s=>s.value==e);l?(o.value=String(l.value),d.value=String(l.text)):(o.value="",d.value="")},S=async()=>{const e=c.cfg;if(!e.ds)return;const a=J(e.ds),l=Q();if(l)return await ae(l,a)},ae=async(e,a)=>{const l=c.cfg;if(!l.ds)return;const s=l.ds,{success:u,data:i,errorMessage:n}=await ve(e,a);if(!u){me(n,"danger");return}f.value.length=0;const m=[];i&&i.length>0&&(O.value=i,i.forEach(q=>{m.push({text:q[s.displayField],value:q[s.valueField]})}));const K=pe(m,"value");return f.value=K,D.value=f.value,U.value=!1,K},le=e=>{const{selectedValues:a}=e;if(a&&a.length>0){o.value=a[0];const l=g(a[0]);d.value=l,w(a[0])}h.value=!1},w=async e=>{const a=c.cfg.ds;if(a&&a.map){const l=O.value.find(s=>s[a.valueField]==e);l&&Object.keys(a.map).forEach(s=>{const u=a.map[s],i=l[s];if(V.value){const n=c.formRow[u];T(n)&&n!=i&&R(c.cfg,u,i)}else R(c.cfg,u,i);L(u,i)})}},te=()=>{d.value="",o.value=null},se=e=>{e?f.value=D.value.filter(a=>String(a.text).includes(e)):f.value=D.value};he(()=>o.value,async e=>{c.cfg.use===b.options?f.value=c.cfg.items.map(l=>({text:l.text,value:l.value})):f.value.length===0?await j():w(o.value);const a=g(o.value)??"";d.value=a,Z(c.cfg,o.value,c.formRow)});const B=v(""),oe=()=>{const e=t.value,a=`setDisabled_${e.uuid}_${e.fullKey}`,l=`setHidden_${e.uuid}_${e.fullKey}`,s=`setColumnHidden_${e.uuid}_${e.fullKey}`,u=`setRules_${e.uuid}_${e.fullKey}`,i=`setClose_${e.uuid}`;y.on(a,n=>{t.value.disabled=n,p("update:field",t.value)}),y.on(l,n=>{t.value.hidden=n,p("update:field",t.value)}),y.on(s,n=>{t.value.hidden=n,p("update:field",t.value)}),y.on(u,n=>{t.value.rules=[n],p("update:field",t.value)}),y.on(i,n=>{B.value=n})};return(e,a)=>{const l=F("van-icon"),s=F("van-field"),u=F("van-search"),i=F("van-picker"),n=F("van-popup");return Ve(),be("div",{class:Fe(r(B))},[ye(Se("div",null,[_(s,{modelValue:r(d),"onUpdate:modelValue":a[0]||(a[0]=m=>E(d)?d.value=m:null),"is-link":!r(t).disabled,readonly:"",name:r(t).bindModel,required:r(t).required,rules:r(t).rules,disabled:r(t).disabled,label:r(t).fieldLabel,placeholder:r(t).placeholder,"clear-icon":"close",onClick:z},we({button:x(()=>[_(ke,{field:r(t)},null,8,["field"])]),_:2},[r(t).clearIcon?{name:"right-icon",fn:x(()=>[_(l,{name:"close",onClick:xe(te,["stop"])})]),key:"0"}:void 0]),1032,["modelValue","is-link","name","required","rules","disabled","label","placeholder"]),_(n,{show:r(h),"onUpdate:show":a[3]||(a[3]=m=>E(h)?h.value=m:null),position:"bottom","safe-area-inset-top":!0,"safe-area-inset-bottom":!0},{default:x(()=>[_(i,{columns:r(f),"model-value":[o.value],onCancel:a[2]||(a[2]=m=>h.value=!1),loading:r(U),onConfirm:le},{"columns-top":x(()=>[_(u,{modelValue:r(C),"onUpdate:modelValue":[a[1]||(a[1]=m=>E(C)?C.value=m:null),se],placeholder:e.$t("Global.keywordsSearch")},null,8,["modelValue","placeholder"])]),_:1},8,["columns","model-value","loading"])]),_:1},8,["show"])],512),[[_e,!r(t).hidden]])],2)}}}),Ke=Ie(Ne,[["__scopeId","data-v-cbafd891"]]);export{Ke as default};
