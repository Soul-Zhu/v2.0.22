import{d as re,L as R,M as le,W as ce,m as u,c as ie,o as ue,x as de,J as me,K as fe,Q as B,a as m,l as U,v as $,h as v,b as j,r as L,F as P,j as E,u as y,i as pe,G as ge,H as S,I as ve,q as k,g as f,t as Y}from"./main-BnXXyOo5.js";import{u as ye}from"./useDataParams-CrPFuV8M.js";import{u as he}from"./encodeext-DBC3bVZy.js";import{u as Se}from"./formWatch-KqHO0hI-.js";import{_ as be}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useFormEnv-VwQXjqJl.js";import"./useInitFieldState-EKN-2KHT.js";const we={class:"view-table"},Ie={class:"table-container"},Fe=re({__name:"YZDataview",props:R({cfg:{},formRow:{}},{modelValue:{type:String},modelModifiers:{}}),emits:R(["update:field"],["update:modelValue"]),setup(x,{emit:Z}){const{WatchSelfExpress:W}=Se(),{getParams:q,getSchema:H}=ye(),{encodeBase64:b,encode:V}=he(),{getFormValue:K}=ve();le(x,"modelValue");const O=ce(),o=x,p=u(o.cfg),w=u([]),g=u(1),G=u(10),N=u(0),T=u([]),J=u([]),I=ie(()=>o.cfg.gridSettingColumns);ue(async()=>{de(async()=>{W(p.value,o.formRow,e=>{},e=>{p.value.hidden=e,M("update:field",p.value)},e=>{},e=>{}),await Q()}),te(),ne()});const Q=async()=>{if(T.value=await q(o.cfg.ds),J.value=await H(o.cfg.ds),o.cfg.ds){const e=o.cfg;G.value=e.pageSize;const t=setTimeout(()=>{var s;ae((s=e.ds)==null?void 0:s.filter),clearTimeout(t)},200)}},F=(e,t,s=null)=>{const a=new FormData,n=o.cfg.ds;if(!n)return a;const r=n.filter,l=[];for(const d of T.value){const oe={...d};r&&d.name in r||n.type===S.table&&!X(o.cfg.gridSettingColumns,d.name)||l.push(oe)}const i=l.filter(d=>d.dataType==="String").map(d=>d.name),c=b(V(i)),h=b(V(A(n.filter,s)));let D=n.orderBy;D&&(D=b(n.orderBy));const se=(e-1)*t;return a.append("f",h),a.append("lc",c),a.append("o",D),a.append("page",String(e)),a.append("start",String(se)),a.append("limit",String(t)),a},A=(e,t)=>{const s=Object.keys(e);if(s.length<=0)return e;const a={};return s.forEach(n=>{const r=e[n],l=r.op,i=r.value;let c=r.value;r.type==="field"&&(c=t||K(o.cfg,i)),a[n]={op:l,value:c}}),a},_=e=>{let t="";return e?(e.type===S.table&&e.dataSourceId&&e.tableName?t=k.getDataBowerTablePage.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName}):e.type===S.esb&&e.dataSourceId?t=k.getDataBowerEsbPage.url.toFetchUrl({params1:e.dataSourceId}):e.type===S.form&&e.dataSourceId&&e.tableName&&(t=k.getDataBowerFormPage.url.toFetchUrl({params1:e.dataSourceId,params2:e.tableName})),t):""},X=(e,t)=>e.find(a=>a.dataIndex===t),ee=async e=>{g.value=e;const t=_(o.cfg.ds);if(!t)return;const s=F(e,o.cfg.pageSize);await C(t,s)},te=async()=>{const e=_(o.cfg.ds);if(!e)return;const t=F(g.value,o.cfg.pageSize);await C(e,t)},C=async(e,t)=>{const{success:s,data:a,errorMessage:n}=await me(e,t);if(!s){fe(n,"danger");return}const r=a.children;N.value=a.total,w.value.length=0;const l=[];for(const i of r){const c={};I.value.forEach(h=>{c[h.dataIndex]=i[h.dataIndex]}),l.push(c)}w.value=l},ae=e=>{const t=O.getCurrentFormId;if(!e)return;const s=Object.keys(e);s.length<=0||s.forEach(a=>{const n=e[a];if(n.type==="field"){const r=`onField_Filter_${n.value}_${t}`;B.on(r,async({currentValue:l})=>{const i=_(o.cfg.ds);if(i){const c=F(g.value,o.cfg.pageSize,l);await C(i,c)}})}})},M=Z,z=u(""),ne=()=>{const e=p.value,t=`setHidden_${e.uuid}_${e.fullKey}`,s=`setClose_${e.uuid}`;B.on(t,a=>{p.value.hidden=a,M("update:field",p.value)}),B.on(s,a=>{z.value=a})};return(e,t)=>{const s=L("YZTitleBar"),a=L("van-pagination");return f(),m("div",{class:ge(y(z))},[U(v("div",we,[j(s,{title:e.cfg.fieldLabel},null,8,["title"]),v("div",Ie,[v("table",null,[v("thead",null,[v("tr",null,[(f(!0),m(P,null,E(y(I),n=>(f(),m("th",{key:n.dataIndex},Y(n.text),1))),128))])]),v("tbody",null,[(f(!0),m(P,null,E(y(w),(n,r)=>(f(),m("tr",{key:r},[(f(!0),m(P,null,E(y(I),l=>(f(),m("td",{key:l.dataIndex},Y(n[l.dataIndex]),1))),128))]))),128))])])]),U(j(a,{style:{"margin-top":"10px"},"items-per-page":e.cfg.pageSize,modelValue:y(g),"onUpdate:modelValue":t[0]||(t[0]=n=>pe(g)?g.value=n:null),"total-items":y(N),onChange:ee},null,8,["items-per-page","modelValue","total-items"]),[[$,e.cfg.enablePaging]])],512),[[$,!e.cfg.hidden]])],2)}}}),Ve=be(Fe,[["__scopeId","data-v-ecc28654"]]);export{Ve as default};
