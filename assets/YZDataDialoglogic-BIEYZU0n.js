import{m as o,H as m,q as f,J as b,Y as se,K as ne,I as ue}from"./main-BnXXyOo5.js";import{u as oe}from"./encodeext-DBC3bVZy.js";import{u as ce}from"./useDataParams-CrPFuV8M.js";const de=()=>{const{getFormValue:O}=ue(),h=o([]),I=o([]),D=o(!1),s=o(null),i=o(m.table),N=o(10),g=o(1),w=o(""),p=o([]),C=o(!1),y=o(!1),S=o(!1),{getParams:j,getSchema:z}=ce(),K=e=>{const a=Object.keys(e);if(a.length<=0)return e;const l={};return a.forEach(t=>{const n=e[t],u=n.op,c=n.value;let r=n.value;n.type==="field"&&(r=O(E.value,c)),l[t]={op:u,value:r}}),l},k=e=>{const a=new FormData;if(!e)return a;const{encode:l,encodeBase64:t}=oe(),n=R(e.viewColumns,e.valueField,e.map),u=q(n,e.filter),c=A(u),r=H(n),M=t(l(r)),$=t(l(c)),ee=K(e.filter),ae=t(l(ee)),te=t("");a.append("c",M),a.append("lc",$),a.append("f",ae),a.append("o",te),a.append("limit",String(N.value)),a.append("page",String(g.value));const le=(g.value-1)*N.value;return a.append("start",String(le)),w.value&&a.append("s",w.value),a},F=async(e,a)=>{const{success:l,errorMessage:t,data:n}=await b(e,a);if(l){const u=n.total,c=n.children;if(p.value.length>=u)y.value=!0;else{const r=c.map(M=>({...M,onlyId:se()}))??[];p.value.push(...r)}C.value=!1,g.value++}else ne(t,"danger"),y.value=!0},T=async()=>{if(S.value&&(p.value.length=0,S.value=!1),!s.value)return;const e=k(s.value);if(i.value==m.table&&s.value.dataSourceId&&s.value.tableName){const a=f.getDataBowerTablePage.url.toFetchUrl({params1:s.value.dataSourceId,params2:s.value.tableName});await F(a,e)}else if(i.value==m.esb&&s.value.dataSourceId){const a=f.getDataBowerEsbPage.url.toFetchUrl({params1:s.value.dataSourceId});await F(a,e)}else if(i.value==m.form&&s.value.dataSourceId&&s.value.tableName){const a=f.getDataBowerFormPage.url.toFetchUrl({params1:s.value.dataSourceId,params2:s.value.tableName});await F(a,e)}},L=async()=>{if(!s.value)return;const e=k(s.value);if(i.value==m.table&&s.value.dataSourceId&&s.value.tableName){const a=f.getDataBowerTablePage.url.toFetchUrl({params1:s.value.dataSourceId,params2:s.value.tableName}),{success:l,errorMessage:t,data:n}=await b(a,e);return n}else if(i.value==m.esb&&s.value.dataSourceId){const a=f.getDataBowerEsbPage.url.toFetchUrl({params1:s.value.dataSourceId}),{success:l,errorMessage:t,data:n}=await b(a,e);return n}else if(i.value==m.form&&s.value.dataSourceId&&s.value.tableName){const a=f.getDataBowerFormPage.url.toFetchUrl({params1:s.value.dataSourceId,params2:s.value.tableName}),{success:l,errorMessage:t,data:n}=await b(a,e);return n}return null},U=()=>{g.value=1,p.value.length=0,S.value=!0,C.value=!0,y.value=!1,T()},R=(e,a,l)=>{const t=[];for(const u of e){const c=P(u.columnName),r=x(t,u.columnName);c&&!r&&t.push({...u,columnName:u.columnName})}const n=t.length>0;if(a){const u=P(a),c=x(t,a);u&&!c&&t.push({columnName:a,hidden:n,displayName:""})}if(l&&Object.keys(l).length>0)for(const u in l){const c=P(u),r=x(t,u);c&&!r&&t.push({columnName:u,hidden:n,displayName:""})}return t.length==0&&h.value.forEach(u=>{t.push({columnName:u.columnName,hidden:!1,displayName:""})}),t},q=(e,a)=>{const l=[],t=I.value;for(const n of t){const u={...n};if(!(a&&n.name in a)){if(i.value==m.table){const c=J(e,n.name);if(!c)continue;u.displayName=c.displayName}l.push(u)}}return l},A=e=>{const a=[];for(const l of e)l.dataType=="String"&&a.push(l.name);return a},H=e=>{const a=[];for(const l of e)a.push(l.columnName);return a},P=e=>!!h.value.find(l=>l.columnName==e),x=(e,a)=>!!e.find(t=>t.columnName==a),J=(e,a)=>{const l=e.find(t=>t.columnName==a);return l||null},Y=async e=>{if(e){if(!s.value)return;N.value=s.value.pageSize??10,h.value=await z(s.value),I.value=await j(s.value)}D.value=e},G=e=>{s.value=e,e&&V(e.type)},v=o([]),d=o([]),B=o(!1),Q=e=>{if(v.value.includes(e.onlyId)){const a=v.value.findIndex(t=>t==e.onlyId);v.value.splice(a,1);const l=d.value.findIndex(t=>t.onlyId==e.onlyId);d.value.splice(l,1)}else B.value?(v.value.push(e.onlyId),d.value.push(e)):(v.value=[e.onlyId],d.value=[e])},W=e=>{B.value=e},X=()=>{const e=B.value?d.value:d.value[0];return D.value=!1,e},Z=()=>{const e=o(!1),a=o(!1),l=()=>{i.value==m.esb?a.value=!0:e.value=!0,e.value=!0},t=()=>{e.value=!1,a.value=!1};return{filterShow:e,onRightClick:l,esbfilterShow:a,onCloseFilter:t,onSearchFilter:u=>{w.value=u,U(),t()}}},E=o(null),_=e=>{e&&(E.value=e)},V=e=>{i.value=e};return{setDialogState:Y,setDsModel:G,setDsType:V,loadData:T,showDialog:D,viewPageData:p,loading:C,finished:y,refreshing:S,onRefresh:U,useFilterFunc:Z,onSelectData:Q,selectKeys:v,selectData:d,setMultipe:W,handlerSaveData:X,tableSechem:h,tableParams:I,setCurrentField:_,loadSelftData:L}};export{de as u};
